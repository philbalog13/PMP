import type { CtfChallengeSeed } from '../ctfChallenges';

export const FRAUD_CHALLENGES: CtfChallengeSeed[] = [
    {
        code: 'FRAUD-001',
        title: 'Quand la Fraude Dort',
        description: 'En cas de panne du moteur de fraude, le switch approuve par defaut (fail-open). Un attaquant peut exploiter cette fenetre pour passer des transactions frauduleuses.',
        freeModeDescription: 'Trouvez la configuration fail-open du moteur de fraude et exploitez-la pour approuver des transactions sans scoring.',
        category: 'FRAUD_CNP',
        difficulty: 'INTERMEDIATE',
        points: 200,
        flagValue: 'PMP{FRAUD_FAILOPEN_APPROVE}',
        targetService: 'sim-auth-engine',
        targetEndpoint: 'POST http://sim-fraud-detection:8007/fraud/check',
        vulnerabilityType: 'Fail-open on error',
        attackVector: 'Dependency failure exploitation',
        learningObjectives: ['Comprendre fail-open vs fail-closed', 'Mesurer le risque operationnel d un fail-open', 'Concevoir un mode degrade securise'],
        estimatedMinutes: 25,
        isActive: true,
        relatedWorkshopPath: '/student/theory/fraud-detection',
        guidedSteps: [
            { stepNumber: 1, stepTitle: 'Transaction normale', stepDescription: 'Envoyez une transaction suspecte pour observer le scoring normal.', stepType: 'CURL_COMMAND', commandTemplate: 'curl -s -X POST http://sim-fraud-detection:8007/fraud/check -H "Content-Type: application/json" -d "{\\"pan\\":\\"4111111111111111\\",\\"amount\\":5000,\\"country\\":\\"NG\\",\\"mcc\\":\\"7995\\"}" | jq .', expectedOutput: 'DECLINE ou REVIEW — score eleve pour montant eleve + pays a risque + MCC gambling' },
            { stepNumber: 2, stepTitle: 'Decouverte du mode degrade', stepDescription: 'Cherchez le mode de configuration du failover dans le moteur de fraude.', stepType: 'CURL_COMMAND', commandTemplate: 'curl -s http://sim-fraud-detection:8007/fraud/config | jq .', expectedOutput: 'Config avec failMode: "open" ou fallbackDecision: "APPROVE"' },
            { stepNumber: 3, stepTitle: 'Activation du fail-open', stepDescription: 'Provoquez une erreur pour activer le behavior fail-open et envoyez une transaction frauduleuse.', stepType: 'CURL_COMMAND', commandTemplate: 'curl -s -X POST http://sim-fraud-detection:8007/fraud/config -H "Content-Type: application/json" -d "{\\"simulateFailure\\":true}" && curl -s -X POST http://sim-fraud-detection:8007/fraud/check -H "Content-Type: application/json" -d "{\\"pan\\":\\"4111111111111111\\",\\"amount\\":9999,\\"country\\":\\"NG\\",\\"mcc\\":\\"7995\\"}" | jq .', expectedOutput: 'APPROVE malgre tous les indicateurs de fraude — fail-open actif' },
            { stepNumber: 4, stepTitle: 'Exploitation en masse', stepDescription: 'Pendant la fenetre fail-open, toutes les transactions passent sans scoring.', stepType: 'CURL_COMMAND', commandTemplate: 'for i in $(seq 1 5); do curl -s -X POST http://sim-fraud-detection:8007/fraud/check -H "Content-Type: application/json" -d "{\\"pan\\":\\"4111111111111111\\",\\"amount\\":$((i*2000)),\\"country\\":\\"NG\\"}" | jq -r .decision; done' },
            { stepNumber: 5, stepTitle: 'Impact financier', stepDescription: 'Pendant une panne de 10 minutes avec fail-open, des milliers de transactions frauduleuses peuvent etre approuvees. Impact = pertes massives.', stepType: 'ANALYSIS' },
            { stepNumber: 6, stepTitle: 'Capture du flag', stepDescription: 'Le flag decrit le comportement fail-open du moteur de fraude.', stepType: 'EXPLOITATION' },
        ],
        hints: [
            { hintNumber: 1, hintText: 'Cherchez un endpoint /fraud/config ou /fraud/status qui revele le mode fallback.', costPoints: 5 },
            { hintNumber: 2, hintText: 'Quand le moteur est en erreur, il approuve par defaut (fail-open) au lieu de refuser (fail-closed).', costPoints: 10 },
            { hintNumber: 3, hintText: 'Le flag suit le format PMP{...}. Validez votre exploitation pour le recuperer.', costPoints: 25 },
        ],
    },
    {
        code: 'FRAUD-002',
        title: 'Score Optimise',
        description: 'Le scoring fraude repose sur des seuils statiques. En manipulant les attributs de la transaction (montant, pays, MCC), on peut garder le score juste sous le seuil de blocage.',
        freeModeDescription: 'Le modele de scoring a un seuil fixe. Trouvez-le et construisez des transactions qui passent juste en dessous.',
        category: 'FRAUD_CNP',
        difficulty: 'ADVANCED',
        points: 250,
        flagValue: 'PMP{FRAUD_SCORE_GAMING}',
        prerequisiteChallengeCode: 'FRAUD-001',
        targetService: 'sim-auth-engine',
        targetEndpoint: 'POST http://sim-fraud-detection:8007/fraud/check',
        vulnerabilityType: 'Score threshold gaming',
        attackVector: 'Feature manipulation',
        learningObjectives: ['Comprendre le scoring fraude basique', 'Identifier les seuils de decision exploitables', 'Construire des transactions evasives'],
        estimatedMinutes: 35,
        isActive: true,
        relatedWorkshopPath: '/student/theory/fraud-detection',
        guidedSteps: [
            { stepNumber: 1, stepTitle: 'Comprehension du scoring', stepDescription: 'Envoyez des transactions avec differents parametres pour comprendre comment le score est calcule.', stepType: 'CURL_COMMAND', commandTemplate: 'curl -s -X POST http://sim-fraud-detection:8007/fraud/check -H "Content-Type: application/json" -d "{\\"pan\\":\\"4111111111111111\\",\\"amount\\":100,\\"country\\":\\"FR\\",\\"mcc\\":\\"5411\\"}" | jq "{decision, score}"', expectedOutput: 'APPROVE avec un score bas' },
            { stepNumber: 2, stepTitle: 'Identification des features', stepDescription: 'Testez chaque feature isolement : montant, pays, MCC, heure. Identifiez leur poids dans le score.', stepType: 'CURL_COMMAND', commandTemplate: 'echo "=== High amount ===" && curl -s -X POST http://sim-fraud-detection:8007/fraud/check -H "Content-Type: application/json" -d "{\\"pan\\":\\"4111111111111111\\",\\"amount\\":5000,\\"country\\":\\"FR\\",\\"mcc\\":\\"5411\\"}" | jq .score && echo "=== Risky country ===" && curl -s -X POST http://sim-fraud-detection:8007/fraud/check -H "Content-Type: application/json" -d "{\\"pan\\":\\"4111111111111111\\",\\"amount\\":100,\\"country\\":\\"NG\\",\\"mcc\\":\\"5411\\"}" | jq .score && echo "=== Risky MCC ===" && curl -s -X POST http://sim-fraud-detection:8007/fraud/check -H "Content-Type: application/json" -d "{\\"pan\\":\\"4111111111111111\\",\\"amount\\":100,\\"country\\":\\"FR\\",\\"mcc\\":\\"7995\\"}" | jq .score' },
            { stepNumber: 3, stepTitle: 'Detection du seuil', stepDescription: 'Augmentez progressivement le score pour trouver le seuil exact de DECLINE.', stepType: 'CURL_COMMAND', commandTemplate: 'for amt in 500 1000 1500 2000 2500 3000; do echo -n "Amount $amt: "; curl -s -X POST http://sim-fraud-detection:8007/fraud/check -H "Content-Type: application/json" -d "{\\"pan\\":\\"4111111111111111\\",\\"amount\\":$amt,\\"country\\":\\"FR\\",\\"mcc\\":\\"5411\\"}" | jq -r "\\(.score) -> \\(.decision)"; done', expectedOutput: 'Seuil identifie — score >= 70 = DECLINE' },
            { stepNumber: 4, stepTitle: 'Construction d une TX evasive', stepDescription: 'Construisez une transaction frauduleuse (montant eleve) mais avec des features qui gardent le score a 69/100.', stepType: 'CURL_COMMAND', commandTemplate: 'curl -s -X POST http://sim-fraud-detection:8007/fraud/check -H "Content-Type: application/json" -d "{\\"pan\\":\\"4111111111111111\\",\\"amount\\":2000,\\"country\\":\\"FR\\",\\"mcc\\":\\"5411\\",\\"deviceFingerprint\\":\\"known_device\\",\\"isRecurring\\":true}" | jq "{score, decision}"', expectedOutput: 'score: 66-69, decision: APPROVE pour 2000 EUR' },
            { stepNumber: 5, stepTitle: 'Patterns d evasion', stepDescription: 'Les fraudeurs repartissent le risque : pays safe + MCC normal + device connu + recurring = score bas malgre montant eleve.', stepType: 'ANALYSIS' },
            { stepNumber: 6, stepTitle: 'Capture du flag', stepDescription: 'Le scoring est gameable avec des seuils statiques.', stepType: 'EXPLOITATION' },
        ],
        hints: [
            { hintNumber: 1, hintText: 'Testez differentes combinaisons de features et observez comment le score varie. Trouvez le seuil exact de blocage.', costPoints: 5 },
            { hintNumber: 2, hintText: 'Le seuil est autour de 70. Gardez le score a 69 en utilisant des features "safe" (pays FR, MCC normal, recurring true).', costPoints: 15 },
            { hintNumber: 3, hintText: 'Le flag suit le format PMP{...}. Validez votre exploitation pour le recuperer.', costPoints: 25 },
        ],
    },
];

