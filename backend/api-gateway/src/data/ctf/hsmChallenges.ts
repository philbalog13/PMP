import type { CtfChallengeSeed } from '../ctfChallenges';

export const HSM_CHALLENGES: CtfChallengeSeed[] = [
    {
        code: 'HSM-001',
        title: 'Le Coffre Ouvert',
        description: 'Un endpoint admin du HSM expose les cles cryptographiques sans aucune authentification. Decouvrez-le, extrayez les cles et mesurez l impact.',
        freeModeDescription: 'Explorez les endpoints admin du HSM simulator. L un d entre eux revele des secrets critiques sans controle d acces.',
        category: 'HSM_ATTACK',
        difficulty: 'BEGINNER',
        points: 100,
        flagValue: 'PMP{HSM_KEYS_NO_AUTH}',
        targetService: 'hsm-simulator',
        targetEndpoint: 'GET http://hsm-simulator:8011/hsm/keys',
        vulnerabilityType: 'Broken access control',
        attackVector: 'Endpoint enumeration',
        learningObjectives: ['Enumerer les endpoints d un service', 'Identifier un endpoint non protege', 'Evaluer l impact d une fuite de cles cryptographiques'],
        estimatedMinutes: 15,
        isActive: true,
        relatedWorkshopPath: '/student/theory/hsm-keys',
        guidedSteps: [
            { stepNumber: 1, stepTitle: 'Decouverte du service', stepDescription: 'Le HSM simulator expose une API REST sur le reseau cible. Confirmez qu il repond en testant un endpoint de diagnostic standard.', stepType: 'CURL_COMMAND', commandTemplate: 'curl -s http://hsm-simulator:8011/hsm/status', expectedOutput: 'Reponse JSON avec le statut du HSM', hintText: 'Tout service REST expose generalement un endpoint de sante ou de statut.' },
            { stepNumber: 2, stepTitle: 'Enumeration des routes', stepDescription: 'Testez les endpoints courants d un HSM : keys, config, encrypt, decrypt, verify-mac, generate-key.', stepType: 'CURL_COMMAND', commandTemplate: 'for path in keys config status encrypt decrypt verify-mac generate-key; do echo "--- /hsm/$path ---"; curl -s -o /dev/null -w "%{http_code}" http://hsm-simulator:8011/hsm/$path; echo; done', expectedOutput: '200 sur /hsm/keys sans authentification' },
            { stepNumber: 3, stepTitle: 'Extraction des cles et du flag', stepDescription: 'L endpoint que vous avez decouvert repond 200 sans authentification et retourne les cles HSM ET votre flag unique dans la reponse JSON. Incluez votre identifiant etudiant dans la requete pour recevoir votre flag personnel.', stepType: 'CURL_COMMAND', commandTemplate: 'curl -s -H "x-student-id: $STUDENT_ID" http://hsm-simulator:8011/hsm/keys | jq .', expectedOutput: 'JSON avec les cles ET un champ "flag" contenant votre PMP{...} unique' },
            { stepNumber: 4, stepTitle: 'Verification absence d auth', stepDescription: 'Confirmez qu aucun mecanisme d authentification n est en place.', stepType: 'CURL_COMMAND', commandTemplate: 'curl -v http://hsm-simulator:8011/hsm/keys 2>&1 | grep -iE "authorization|www-authenticate|401|403"', expectedOutput: 'Aucun header d authentification — Broken Access Control confirme' },
            { stepNumber: 5, stepTitle: 'Identification des cles critiques', stepDescription: 'ZPK chiffre les PIN blocks en transit. ZAK authentifie les messages ISO 8583. DEK chiffre les donnees sensibles. Toutes ces cles sont exposees sans protection.', stepType: 'ANALYSIS', hintText: 'Une ZPK compromise = TOUS les PIN blocks en transit peuvent etre dechiffres.' },
            { stepNumber: 6, stepTitle: 'Evaluation de l impact', stepDescription: 'Avec ces cles, un attaquant peut dechiffrer les PIN, forger des messages ISO valides, et lire les donnees chiffrees. Impact = compromission totale.', stepType: 'ANALYSIS' },
            { stepNumber: 7, stepTitle: 'Capture du flag', stepDescription: 'Votre flag unique est retourne directement dans la reponse JSON de l endpoint que vous avez decouvert. Incluez votre identifiant etudiant dans la requete pour recevoir un flag personnalise. Soumettez la valeur PMP{...} dans le portail.', stepType: 'EXPLOITATION', hintText: 'Le flag se trouve dans un champ de la reponse JSON. Ajoutez votre identifiant etudiant via un header HTTP pour le personnaliser.' },
        ],
        hints: [
            { hintNumber: 1, hintText: 'Categorie : Broken Access Control (OWASP A01). Un endpoint d administration HSM est accessible sans authentification.', costPoints: 5 },
            { hintNumber: 2, hintText: 'Outils recommandes : curl, ffuf ou nmap. Enumerez les endpoints REST courants d un HSM — les chemins d administration typiques exposent des ressources sensibles.', costPoints: 12 },
            { hintNumber: 3, hintText: 'Le flag se trouve dans le corps JSON de la reponse. Identifiez-vous aupres du service via un header HTTP pour recevoir un flag personnalise.', costPoints: 25 },
        ],
    },
    {
        code: 'HSM-002',
        title: 'Cles Previsibles',
        description: 'Parmi les cles du HSM, une ZPK de test a une valeur triviale (motif repete). Une ZPK faible compromet la confidentialite de tous les PIN blocks.',
        freeModeDescription: 'Inspectez les cles exposees. L une a une valeur qui ne respecte aucun standard d entropie. Identifiez-la.',
        category: 'HSM_ATTACK',
        difficulty: 'INTERMEDIATE',
        points: 150,
        flagValue: 'PMP{ZPK_11111111111111111111111111111111}',
        prerequisiteChallengeCode: 'HSM-001',
        targetService: 'hsm-simulator',
        targetEndpoint: 'backend/hsm-simulator/src/core/KeyStorage.ts',
        vulnerabilityType: 'Weak keys',
        attackVector: 'Default seed inspection',
        learningObjectives: ['Identifier un pattern de cle faible', 'Comprendre l impact d une ZPK previsible', 'Distinguer cle de test vs production'],
        estimatedMinutes: 20,
        isActive: true,
        relatedWorkshopPath: '/student/theory/hsm-keys',
        guidedSteps: [
            { stepNumber: 1, stepTitle: 'Recuperation des cles', stepDescription: 'Recupérez toutes les cles du HSM avec l exploit du challenge precedent.', stepType: 'CURL_COMMAND', commandTemplate: 'curl -s http://hsm-simulator:8011/hsm/keys | jq .', expectedOutput: 'Liste complete des cles avec labels et valeurs' },
            { stepNumber: 2, stepTitle: 'Analyse des labels', stepDescription: 'Identifiez les cles par leur label. ZPK = Zone PIN Key. Cherchez les labels contenant TEST.', stepType: 'CURL_COMMAND', commandTemplate: 'curl -s http://hsm-simulator:8011/hsm/keys | jq -r ".[] | .label + \\": \\" + .value"', expectedOutput: 'ZPK_TEST avec une valeur suspecte' },
            { stepNumber: 3, stepTitle: 'Detection du pattern faible', stepDescription: 'Examinez la valeur de ZPK_TEST. Un motif repete (1111...1) = entropie zero.', stepType: 'ANALYSIS', hintText: 'Comptez les caracteres uniques. Une vraie cle AES-256 a 64 hex aleatoires.' },
            { stepNumber: 4, stepTitle: 'Verification blackbox', stepDescription: 'Confirmez la faiblesse de ZPK_TEST via l API sans lire le code source.', stepType: 'CURL_COMMAND', commandTemplate: 'curl -s http://hsm-simulator:8011/hsm/keys | jq -r \'.keys[]? | select(.label=="ZPK_TEST") | .value\'', hintText: 'Une cle de test avec motif repetitif indique une configuration hardcodee ou non aleatoire.' },
            { stepNumber: 5, stepTitle: 'Impact : dechiffrement PIN', stepDescription: 'Avec la ZPK connue, un attaquant dechiffre tout PIN block en transit. Il peut recuperer le code PIN de chaque porteur.', stepType: 'ANALYSIS' },
            { stepNumber: 6, stepTitle: 'Capture du flag', stepDescription: 'Votre flag unique est cache dans les headers HTTP de la reponse, pas dans le body JSON. Inspectez les headers de reponse en incluant votre identifiant etudiant dans la requete.', stepType: 'EXPLOITATION', hintText: 'Utilisez un outil qui affiche les headers de reponse HTTP. Les headers custom commencent generalement par X-CTF-.' },
        ],
        hints: [
            { hintNumber: 1, hintText: 'Concentrez-vous sur la cle ZPK_TEST et examinez sa valeur hexadecimale.', costPoints: 5 },
            { hintNumber: 2, hintText: 'La valeur est un motif repete : 32 fois le meme chiffre "1".', costPoints: 10 },
            { hintNumber: 3, hintText: 'Le flag suit le format PMP{...}. Validez votre exploitation pour le recuperer.', costPoints: 25 },
        ],
    },
    {
        code: 'HSM-003',
        title: 'Fuite dans les Logs',
        description: 'Le HSM est deploy\u00e9 avec un mode de journalisation mis-configur\u00e9 qui logue le mat\u00e9riel cryptographique en clair. D\u00e9couvrez comment d\u00e9clencher la fuite et extrayez votre flag depuis les logs.',
        freeModeDescription: 'Une mis-configuration du HSM provoque la journalisation des cl\u00e9s en clair lors de certaines op\u00e9rations. D\u00e9clenchez une op\u00e9ration crypto et observez les logs.',
        category: 'HSM_ATTACK',
        difficulty: 'INTERMEDIATE',
        points: 200,
        flagValue: 'PMP{KEY_LEAK_IN_LOGS}',
        prerequisiteChallengeCode: 'HSM-002',
        targetService: 'hsm-simulator',
        // Hidden until solved — students must discover the vulnerable operation themselves
        targetEndpoint: 'POST /hsm/encrypt-data (avec keyLabel)',
        vulnerabilityType: 'Sensitive data in logs',
        attackVector: 'Cryptographic material logged in plaintext',
        learningObjectives: [
            'D\u00e9couvrir une fuite de secrets via les logs serveur',
            'Comprendre pourquoi les cl\u00e9s ne doivent jamais appara\u00eetre dans des logs',
            'Conna\u00eetre PCI DSS Exigence 3 sur la protection des SAD',
        ],
        estimatedMinutes: 25,
        isActive: true,
        relatedWorkshopPath: '/student/theory/hsm-keys',
        // keyLeakInLogs=true est PRE-ACTIVE par CHALLENGE_DEFAULTS dans VulnEngine.
        // Les \u00e9tudiants n\u2019ont PAS besoin (ni la possibilit\u00e9) de l\u2019activer eux-m\u00eames.
        // Ils doivent TROUVER l\u2019op\u00e9ration qui d\u00e9clenche la fuite, puis lire les logs.
        initialVulnConfig: { keyLeakInLogs: true },
        guidedSteps: [
            {
                stepNumber: 1,
                stepTitle: 'Cartographie des op\u00e9rations HSM',
                stepDescription: 'Le HSM expose plusieurs endpoints crypto. Identifiez lesquels acceptent un param\u00e8tre keyLabel ou key dans le body — ce sont ces op\u00e9rations qui manipulent du mat\u00e9riel cryptographique.',
                stepType: 'EXPLANATION',
                hintText: 'Pensez \u00e0 : chiffrement, d\u00e9chiffrement, g\u00e9n\u00e9ration de MAC, v\u00e9rification. Laquelle envoie une cl\u00e9 dans le body ?',
            },
            {
                stepNumber: 2,
                stepTitle: 'D\u00e9clenchement d\u2019une op\u00e9ration crypto',
                stepDescription: 'Invoquez une op\u00e9ration du HSM qui transmet du mat\u00e9riel cryptographique (keyLabel, pinBlock, clearKey\u2026). N\u2019oubliez pas d\u2019inclure votre x-student-id dans le header pour que le flag vous soit attribu\u00e9.',
                stepType: 'CURL_COMMAND',
                // commandTemplate null ici = invisible jusqu'\u00e0 complétion du challenge
                expectedOutput: 'R\u00e9ponse JSON de l\u2019op\u00e9ration ; la fuite, elle, est dans les LOGS serveur',
                hintText: 'Ajoutez -H "x-student-id: $STUDENT_ID" \u00e0 votre curl.',
            },
            {
                stepNumber: 3,
                stepTitle: 'Lecture des logs du container HSM',
                stepDescription: 'Acc\u00e9dez aux logs du container hsm-simulator. Cherchez les lignes tagu\u00e9es [VULN:LEAK] \u2014 elles contiennent le mat\u00e9riel cryptographique log\u00e9 en clair ET votre flag personnel dans le champ "ctf_flag".',
                stepType: 'OBSERVATION',
                // commandTemplate null = invisible jusqu'\u00e0 complétion
                expectedOutput: 'Ligne JSON avec "ctf_flag":"PMP{KEY_LEAK_IN_LOGS_XXXXXX}"',
                hintText: 'Les logs Docker sont accessibles via l\u2019API Gateway ou directement sur le container. Cherchez [VULN:LEAK].',
            },
            {
                stepNumber: 4,
                stepTitle: 'Analyse de l\u2019impact PCI DSS',
                stepDescription: 'PCI DSS Exigence 3 interdit de stocker les Sensitive Authentication Data (SAD) apr\u00e8s autorisation. Logger une cl\u00e9 AES ou un PIN block en clair constitue une violation directe exposant tout le CDE.',
                stepType: 'ANALYSIS',
            },
            {
                stepNumber: 5,
                stepTitle: 'Soumission du flag',
                stepDescription: 'Copiez la valeur PMP{...} que vous avez trouv\u00e9e dans les logs et soumettez-la dans le portail. Votre flag est personnel \u2014 il ne fonctionnera pas pour un autre \u00e9tudiant.',
                stepType: 'EXPLOITATION',
                hintText: 'Le flag est dans le champ "ctf_flag" de la ligne [VULN:LEAK] des logs du container pmp-hsm-simulator.',
            },
        ],
        hints: [
            {
                hintNumber: 1,
                hintText: 'Broken access control (OWASP A01). La vuln\u00e9rabilit\u00e9 est une mis-configuration de logging, pas un endpoint public.',
                costPoints: 5,
            },
            {
                hintNumber: 2,
                hintText: 'Outil : curl + docker logs. D\u00e9clenchez une op\u00e9ration crypto qui passe un keyLabel dans le body, puis lisez les logs serveur.',
                costPoints: 12,
            },
            {
                hintNumber: 3,
                hintText: 'Le flag est dans les logs JSON du container (champ "ctf_flag"), sur les lignes tagu\u00e9es [VULN:LEAK]. Envoyez votre student-id dans le header x-student-id.',
                costPoints: 25,
            },
        ],
    },
    {
        code: 'HSM-004',
        title: 'Le Pingouin ECB',
        description: 'Le mode ECB chiffre chaque bloc independamment. Les patterns dans les donnees claires se retrouvent dans le chiffre — le celebre "pingouin ECB".',
        freeModeDescription: 'Prouvez que le mode ECB fuit la structure des donnees en chiffrant des donnees repetitives et en comparant les blocs de sortie.',
        category: 'HSM_ATTACK',
        difficulty: 'ADVANCED',
        points: 250,
        flagValue: 'PMP{ECB_LEAKS_PATTERNS}',
        prerequisiteChallengeCode: 'HSM-003',
        targetService: 'hsm-simulator',
        targetEndpoint: 'POST /hsm/encrypt-data',
        vulnerabilityType: 'Insecure cipher mode',
        attackVector: 'Block pattern analysis',
        learningObjectives: ['Comprendre la difference ECB vs CBC/GCM', 'Prouver la fuite structurelle du mode ECB', 'Evaluer l impact sur la confidentialite'],
        estimatedMinutes: 30,
        isActive: true,
        relatedWorkshopPath: '/student/theory/hsm-keys',
        guidedSteps: [
            { stepNumber: 1, stepTitle: 'Chiffrement CBC de reference', stepDescription: 'Chiffrez des donnees repetitives en mode CBC pour obtenir une reference securisee.', stepType: 'CURL_COMMAND', commandTemplate: 'curl -s -X POST http://hsm-simulator:8011/hsm/encrypt-data -H "Content-Type: application/json" -d "{\\"data\\":\\"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\",\\"keyLabel\\":\\"DEK_AES_001\\",\\"mode\\":\\"CBC\\"}" | jq .ciphertext', expectedOutput: 'Blocs chiffres tous differents grace a l IV et au chainage' },
            { stepNumber: 2, stepTitle: 'Chiffrement ECB', stepDescription: 'Les memes donnees en mode ECB.', stepType: 'CURL_COMMAND', commandTemplate: 'curl -s -X POST http://hsm-simulator:8011/hsm/encrypt-data -H "Content-Type: application/json" -d "{\\"data\\":\\"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\",\\"keyLabel\\":\\"DEK_AES_001\\",\\"mode\\":\\"ECB\\"}" | jq .ciphertext', expectedOutput: 'BLOCS IDENTIQUES ! Meme entree = meme sortie' },
            { stepNumber: 3, stepTitle: 'Comparaison visuelle', stepDescription: 'En ECB, les blocs identiques produisent le meme chiffre. Decoupez en blocs de 32 hex.', stepType: 'ANALYSIS', hintText: 'Les blocs de 16 octets (32 hex) se repetent en ECB.' },
            { stepNumber: 4, stepTitle: 'Test determinisme', stepDescription: 'Chiffrez deux fois les memes donnees en ECB. Le ciphertext est identique — pas d IV/nonce.', stepType: 'CURL_COMMAND', commandTemplate: 'echo "=== Run 1 ===" && curl -s -X POST http://hsm-simulator:8011/hsm/encrypt-data -H "Content-Type: application/json" -d "{\\"data\\":\\"SECRET\\",\\"keyLabel\\":\\"DEK_AES_001\\",\\"mode\\":\\"ECB\\"}" | jq .ciphertext && echo "=== Run 2 ===" && curl -s -X POST http://hsm-simulator:8011/hsm/encrypt-data -H "Content-Type: application/json" -d "{\\"data\\":\\"SECRET\\",\\"keyLabel\\":\\"DEK_AES_001\\",\\"mode\\":\\"ECB\\"}" | jq .ciphertext', expectedOutput: 'Outputs identiques — determinisme total' },
            { stepNumber: 5, stepTitle: 'Impact production', stepDescription: 'ECB permet de detecter des PAN identiques et reconstituer des patterns dans une base chiffree.', stepType: 'ANALYSIS' },
            { stepNumber: 6, stepTitle: 'Capture du flag', stepDescription: 'Votre flag unique apparait dans la reponse JSON lorsque vous utilisez le mode de chiffrement non securise avec votre identifiant etudiant. Reproduisez l exploitation avec votre student-id pour obtenir un flag personnel.', stepType: 'EXPLOITATION', hintText: 'Le flag se trouve dans un champ de la reponse JSON. Incluez votre identifiant via le header x-student-id lors de l appel au mode non securise.' },
        ],
        hints: [
            { hintNumber: 1, hintText: 'Testez mode "ECB" et "CBC" avec des donnees repetitives et comparez les sorties.', costPoints: 5 },
            { hintNumber: 2, hintText: 'En ECB, blocs identiques en entree produisent des blocs identiques en sortie.', costPoints: 15 },
            { hintNumber: 3, hintText: 'Le flag suit le format PMP{...}. Validez votre exploitation pour le recuperer.', costPoints: 25 },
        ],
    },
    {
        code: 'HSM-005',
        title: 'Course contre la Montre',
        description: 'La verification MAC utilise une comparaison sequentielle. Le temps de reponse revele combien d octets sont corrects — timing side-channel.',
        freeModeDescription: 'Mesurez les temps de reponse de /hsm/verify-mac avec differents prefixes. La duree revele les octets corrects du MAC.',
        category: 'HSM_ATTACK',
        difficulty: 'EXPERT',
        points: 350,
        flagValue: 'PMP{TIMING_ATTACK_MAC}',
        prerequisiteChallengeCode: 'HSM-004',
        targetService: 'hsm-simulator',
        targetEndpoint: 'POST /hsm/verify-mac',
        vulnerabilityType: 'Timing side-channel',
        attackVector: 'Latency correlation',
        learningObjectives: ['Comprendre les attaques timing side-channel', 'Mesurer la correlation latence/bytes corrects', 'Proposer une comparaison constant-time'],
        estimatedMinutes: 40,
        isActive: true,
        relatedWorkshopPath: '/student/theory/hsm-keys',
        guidedSteps: [
            { stepNumber: 1, stepTitle: 'Requete de reference', stepDescription: 'Testez verify-mac avec un MAC completement faux et notez le temps.', stepType: 'CURL_COMMAND', commandTemplate: 'curl -s -w "\\nTime: %{time_total}s\\n" -X POST http://hsm-simulator:8011/hsm/verify-mac -H "Content-Type: application/json" -d "{\\"data\\":\\"PAYLOAD\\",\\"keyLabel\\":\\"ZAK_002\\",\\"mac\\":\\"0000000000000000\\"}"', expectedOutput: 'valid: false avec un temps de reference' },
            { stepNumber: 2, stepTitle: 'Test de prefixes', stepDescription: 'Essayez differents premiers octets. Si la comparaison est sequentielle, le bon prend plus longtemps.', stepType: 'CURL_COMMAND', commandTemplate: 'for prefix in 00 01 0A 0F 11 22 33 FF; do echo -n "Prefix $prefix: "; curl -s -w "%{time_total}s" -o /dev/null -X POST http://hsm-simulator:8011/hsm/verify-mac -H "Content-Type: application/json" -d "{\\"data\\":\\"PAYLOAD\\",\\"keyLabel\\":\\"ZAK_002\\",\\"mac\\":\\"${prefix}11223344556677\\"}"; echo; done', expectedOutput: 'Un prefix prend legerement plus de temps' },
            { stepNumber: 3, stepTitle: 'Scan du premier octet', stepDescription: 'Scannez les 256 valeurs possibles du premier octet et trouvez le plus lent.', stepType: 'CURL_COMMAND', commandTemplate: 'for i in $(seq 0 15); do hex=$(printf "%02x" $i); echo -n "$hex: "; curl -s -w "%{time_total}" -o /dev/null -X POST http://hsm-simulator:8011/hsm/verify-mac -H "Content-Type: application/json" -d "{\\"data\\":\\"PAYLOAD\\",\\"keyLabel\\":\\"ZAK_002\\",\\"mac\\":\\"${hex}11223344556677\\"}"; echo; done | sort -t: -k2 -rn | head -3', hintText: 'Le byte correct prend quelques ms de plus.' },
            { stepNumber: 4, stepTitle: 'Analyse statistique', stepDescription: 'Pour eliminer le bruit, repetez chaque mesure N fois. Le byte avec la latence moyenne la plus elevee est le bon.', stepType: 'ANALYSIS' },
            { stepNumber: 5, stepTitle: 'Extension byte par byte', stepDescription: 'Avec le 1er octet connu, mesurez le 2eme, puis le 3eme... 8x256 = 2048 requetes max au lieu de 2^64 par brute-force.', stepType: 'ANALYSIS' },
            { stepNumber: 6, stepTitle: 'Remediation', stepDescription: 'Correction : utiliser crypto.timingSafeEqual() qui prend toujours le meme temps.', stepType: 'EXPLANATION' },
            { stepNumber: 7, stepTitle: 'Capture du flag dans le header', stepDescription: 'Votre flag unique est cache dans un header HTTP de reponse de l endpoint que vous avez analyse. Inspectez les headers avec votre identifiant etudiant — la presence du flag confirme que vous avez bien identifie le canal de fuite temporelle.', stepType: 'EXPLOITATION', hintText: 'Le flag se trouve dans un header de reponse HTTP custom. Utilisez un outil qui affiche les headers et incluez votre identifiant etudiant pour recevoir votre flag personnalise.' },
        ],
        hints: [
            { hintNumber: 1, hintText: 'Utilisez curl -w "%{time_total}" pour mesurer les temps de chaque requete.', costPoints: 5 },
            { hintNumber: 2, hintText: 'Comparez les temps pour differents prefixes. Plus d octets corrects = plus de temps si comparaison sequentielle.', costPoints: 15 },
            { hintNumber: 3, hintText: 'Le flag suit le format PMP{...}. Validez votre exploitation pour le recuperer.', costPoints: 25 },
        ],
    },
];


